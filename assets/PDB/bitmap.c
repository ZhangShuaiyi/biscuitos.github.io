

     struct filename

                              +--------+
                              |  name  |----o
                              +--------+    |
                              |        |    |
                              +--------+    |
                              |        |    |
                              +--------+    |
                              |  iname |----o
                              +--------+    |
                              |        |    |
                              |        |    |
                              |        |<---o
                              |        |
                              |        |
                              |        |
                              |        |
                              |        |
                              +--------+




     struct filename

        original                     New                 original

       +--------+                 +--------+            +--------+
       |  name  |----o            |  name  |----------->|        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       +--------+    |            +--------+            |        |
       |  iname |----o   ----->   |  iname |            |        |
       +--------+    |            +--------+            |        |
       |        |    |            |        |            |        |
       |        |    |            |        |            |        |
       |        |<---o            |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       |        |                 |        |            |        |
       +--------+                 +--------+            +--------+












 


 full_fds_bits

 +--+--+--+--+---+-+-+-+-+
 |31|30|29|28|...|3|2|1|0|
 +--+--+--+--+---+-+-+-+-+
                    | | |       open_fds
                    | | |       +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    | | o------>|31|30|29|28|27|26|25|.....|05|04|03|02|01|00|
                    | |         +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    | o-------->|63|62|61|60|59|58|57|.....|37|36|35|34|33|32|
                    |           +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+
                    o---------->|95|94|93|92|91|90|89|.....|69|68|67|66|65|64|
                                +--+--+--+--+--+--+--+-----+--+--+--+--+--+--+






    |<- file type ->| <---------------- permission ---------------> |
    +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
    |   |   |   |   | U | G | T | R | W | X | R | W | X | R | W | X |
    +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
                                |<- User  ->|<- Group ->|<- Other ->|









         1M Cma region:

         +----------------------------------------------------------------------------+
    1)   |                                                                            |
         +----------------------------------------------------------------------------+
         | <-------------------------------- Free ----------------------------------> |


         +-------------------------+---+----------------------------------------------+
    2)   |          A              | B |                                              |
         +-------------------------+---+----------------------------------------------+
         | <---------- Used ---------> |


         +-------------------------+---+----------------------------------------------+
    3)   |                         | B |                                              |
         +-------------------------+---+----------------------------------------------+
         | <------- Free --------> |   | <------------------ Free ------------------> |




                               CMA

                               +-------------------------------------------------------------------------------+
                               |                                                                               |
                               |                                                                               |
                               |                                                                               |
                               +-------------------------------------------------------------------------------+
                             

                               +-----------+-----------------------+-------------------------------------------+
                               |           |                       |                                           |
                               |   Small   |       Middle          |                  Large                    |
                               |           |                       |                                           |
                               +-----------+-----------------------+-------------------------------------------+
                             




                               +---+---+---+-------+----+----+----------+-----+-----+-----+-----+-----+-------+
                           1)  | X | X | X |       | XX | XX |          | XXX | XXX | XXX | XXX | XXX |       |
                               +---+---+---+-------+----+----+----------+-----+-----+-----+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |


                               +---+---+---+------------+----+----------+-----+-----------+-----+-----+-------+
                           2)  | X |   | X |            | XX |          | XXX |           | XXX | XXX |       |
                               +---+---+---+------------+----+----------+-----+-----------+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |


                               +---+---+---+------------+----+----------+-----+-----+-----+-----+-----+-------+
                           3)  | X | X | X |            | XX |          | XXX | XXX |     | XXX | XXX |       |
                               +---+---+---+------------+----+----------+-----+-----+-----+-----+-----+-------+
                               | <- X area -> |    | <- XX area -> |    | <------------ XXX area -----------> |














start_kernel
 |
 o--> setup_arch
       |
       o--> unflatten_device_tree
       |
       o--> arm_memblock_init
             |
             o--> early_init_fdt_scan_reserved_mem
                   |
                   o--> __fdt_scan_reserved_mem
                   |
                   o--> fdt_init_reserved_mem
                         |
                         o--> __reserved_mem_alloc_size
                         |
                         o--> __reserved_mem_init_node
                               .
                               .--> rmem_cma_setup
                                     |
                                     o--> cma_init_reserved_mem
                                     |
                                     o--> dma_contiguous_set_default


start_kernel
 |
 o--> setup_arch
       |
       o--> parse_early_param
       |     |
       |     o--> early_cma
       |
       o--> arm_memblock_init
             |
             o--> dma_contiguous_reserve
                   |
                   o--> dma_contiguous_reserve_area
                         |
                         o--> cma_declare_contiguous
                         |     |
                         |     o--> memblock_alloc_range
                         |     |
                         |     o--> cma_init_reserved_mem
                         |
                         o--> dma_contiguous_early_fixup



make menuconfig

start_kernel
 |
 o--> setup_arch
       |
       o--> arm_memblock_init
             |
             o--> dma_contiguous_reserve
                   |
                   o--> dma_contiguous_reserve_area
                         |
                         o--> cma_declare_contiguous
                         |     |
                         |     o--> memblock_alloc_range
                         |     |
                         |     o--> cma_init_reserved_mem
                         |
                         o--> dma_contiguous_early_fixup






start_kernel
 |
 o--> setup_arch
       |
       o--> paging_init
             |
             o--> dma_contiguous_remap




core_initcall
 |
 o--> cma_init_reserved_areas
       |
       o--> cma_activate_area
             |
             o--> kzalloc
             |
             o--> init_cma_reserved_pageblock
                   |
                   o--> __ClearPageReserved
                   |
                   o--> set_page_count
                   |
                   o--> set_pageblock_migratetype
                   |
                   o--> set_page_refcounted
                   |
                   o--> __free_pages
                   |
                   o--> adjust_managed_page_count




       +----------+-------------+------------------------+-------------+-----------------+
       | Kernel   |             |                        |             |                 |
       |  .data   | Free Memory |          CMA           | Free Memory | Reserved Memory |
       |  .code   |             |                        |             |                 |
       +----------+-------------+------------------------+-------------+-----------------+



       o------------------------------------------------------------------------------------------------------------o
       |                                                                                                            |
       |                                                                                                            V
       |                                                                                                    | <- end_offset ->|
       |        | <----------------------------------------------- map_size ------------------------------------------------> |
       |        +----+--------------------------------------------------------------------------------------+-----------------+
       |        |    |                                                                                      |                 |
       |        |    |                                                                                      |                 |
       |        |    |                                                                                      |                 |
       |        +----+--------------------------------------------------------------------------------------+-----------------+
       |        |<-> A
       |          A  |
       |          |  | Aligned_addr
       |  o-------o  o-----------------------------o
       |  |                                        |
       |  |     pcpu_chunk                         |
       |  |     +--------------------+             |                 struct pcpu_block_md
       |  |     |                    |             |                 +-------------------+
       |  |     +--------------------+             |                 |    contig_hint    |
       |  o-----|    start_offset    |             |                 +-------------------+
       |        +--------------------+             |                 |     right_free    |
       o--------|     end_offset     |             |                 +-------------------+
                +--------------------+             |                 |     left_free     |
                |      base_addr     |-------------o                 +-------------------+
                +--------------------+                               |     first_free    |----o
                |                    |                               +-------------------+    |
                +--------------------+                               | contig_hint_start |    |
                |    md_blocks[0]    |------------------------------>+-------------------+    |
                +--------------------+                                                        |
                |    ............    |                                                        |
                +--------------------+                                                        |
                |    md_blocks[n]    |                                                        |
                +--------------------+                                                        |
                |                    |                                                        |
                +--------------------+                                                        |
                |    contig_bits     |---> (map_size / PCPU_MIN_ALLOC_SIZE)                   |
                +--------------------+                                                        |
                |     free_bytes     |---> (map_size / PCPU_MIN_ALLOC_SIZE)                   |
                +--------------------+                                                        |
                |     first_bit      |--------------------------------o                       |
                +--------------------+                                |         <-- left_free | righ_free -->
                |                    |                                V contig_hint_start     V
                +--------------------+                              +----------------------------------------------------------+
                |     alloc_map      |----------------------------> |                        alloc BITMAP                      |
                +--------------------+                              +----------------------------------------------------------+
                |     bound_map      |----------------------------> |                        bound BITMAP                      |
                +--------------------+                              +----------------------------------------------------------+
                |                    |
                +--------------------+
                |                    |
                +--------------------+                              +---------------------------------------+
                |    populated[0]    |----------------------------> |         Populate Page BITMAP          |
                +--------------------+                              +---------------------------------------+
                |    populated[1]    |
                +--------------------+
                |    ............    |
                +--------------------+
                |    populated[n]    |
                +--------------------+





           
                pcpu_alloc_info
                +-----------+
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                |           |
                +-----------+                pcpu_group_info
                | groups[0] |--------------->+-------------+
                +-----------+                |   nr_units  |
                | groups[1] |                +-------------+
                +-----------+                | base_offset |
                | ......... |                +-------------+
                +-----------+                |  cpu_map[0] |----------->+---------------+
                | groups[n] |                +-------------+            |               |
                +-----------+                |  cpu_map[1] |            |               |
                                             +-------------+            |               |
                                             | ........... |            |               |
                                             +-------------+            |               |
                                             |  cpu_map[n] |            |               |
                                             +-------------+            |               |
                                                                        |               |
                                                                        |               |
                                                                        |               |
                                                                        |               |
                                                                        +---------------+











     pcpu_chunk
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |                    |
     +--------------------+
     |    populated[0]    |
     +--------------------+
     |    populated[1]    |
     +--------------------+
     |    ............    |
     +--------------------+
     |    populated[n]    |
     +--------------------+



     pcpu_slot_list
     +--------------+
     | pcpu_slot[0] |
     +--------------+
     | pcpu_slot[1] |
     +--------------+
     | pcpu_slot[2] |
     +--------------+
     | pcpu_slot[3] |
     +--------------+
     | pcpu_slot[4] |
     +--------------+
     | pcpu_slot[5] |
     +--------------+
     | pcpu_slot[6] |
     +--------------+
     | pcpu_slot[7] |
     +--------------+
     | pcpu_slot[8] |
     +--------------+
     | pcpu_slot[9] |
     +--------------+
     | pcpu_slot[a] |
     +--------------+
     | pcpu_slot[b] |
     +--------------+
     | pcpu_slot[c] |
     +--------------+
     | pcpu_slot[d] |
     +--------------+
     | pcpu_slot[e] |
     +--------------+
     | pcpu_slot[f] |
     +--------------+



    
         Linux Memory Allocator 
         Life Cycle


                                                                                                       +-----------------------
         +----------+                                                                            o---->| DMA
         |          |                                                                            |     +-----------------------
         |          |--------------------------------------------------------------------------->|
         |          |                                                                            |     +-----------------------
         |          |                                                                            o---->| CMA
         |          |                                                                                  +-----------------------
         |          |                                                                       VMALLOC    +-----------------------
         |          |      +----------------------------------------------------------------(+)------->| PERCPU-vm
         | MEMBLOCK |----->| PERCPU                                                                    +-----------------------
         |          |      +----------------------------------------------------------------(+)------->| PERCPU-km 
         |          |                                                                        |         +-----------------------
         |          |               +------------------------------------------------------------------------------------------
         |          |-------------->| Buddy Memory 
         |          |               +------------------------------------------------------------------------------------------
         |          |                    |           
         |          |                    |                                  +--------------------------------------------------
         |          |                    |         +----------------------->| Kmem_cache
         |          |                    o-------->| SLAB/SLUB/SLOB         +--------------------------------------------------
         +----------+                    |         +----------------------->| Kmalloc
                                         |                                  +--------------------------------------------------
                                         |                                         |      +------------------------------------
                                         o----------------------------------------(+)---->| VMALLOC
                                         |                                                +------------------------------------
                                         |
                                         |              +----------------------------------------------------------------------
                                         o------------->| FIXMAP 
                                         |              +----------------------------------------------------------------------
                                         |                    |
                                         |                    |       +--------------------------------------------------------
                                         o-------------------(+)----->| KMAP
                                                                      +--------------------------------------------------------


  
    Linux Virtual Address


    ERROR AREA   Userspace                                                              Kernel Space
     |<--->| <---------------> |                  | <-------------------------------------------------------------------------------------------> |
     +----------------------------------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     |                         |        |  PKMAP  |    |       |  | Kernel Image |                 |     |   VMALLOC AREA   |  |   FIXMAP   |  |  |
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     +-------------------------+--------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
                               A        A         A    A <---> |  A              A <- lowmemory -> | <-> |                  A  A            A  A
                               |        |         |    |   A      |              |                 A  A  A                  |  |            |  |
                               |        |         |    |   |      |              |                 |  |  |                  |  |            |  o-- FIXADDR_END(0xfff00000UL)
                               |        |         |    |   |      |              |                 |  |  |                  |  |            o----- FIXADDR_TOP
     TASK_SIZE ----------------o        |         |    |   |      |              |                 |  |  |                  |  o------------------ FIXADDR_START(0xffc00000UL)
     PKMAP_BASE ------------------------o         |    |   |      |              |                 |  |  |                  |
                              PAGE_OFFSET --------o    |   |      |              |                 |  |  |                  o--- VMALLOC_END(0xff800000UL)
                              swapper_pg_dir ----------o   |      |              |                 |  |  o---------------------- VMALLOC_START
                              Kernel page table directory -o      |              |                 |  o------------------------- VMALLOC_OFFSET(8M)
                              KERNEL_START/_stext ----------------o              |                 o---------------------------- high_memory
                              KERNEL_END/_end -----------------------------------o










	MEMBLOCK
	
	
	                                         struct memblock_region
	                       struct            +------+------+--------+------+
	                       memblock_type     |      |      |        |      |
	                       +----------+      | Reg0 | Reg1 | ...    | Regn |
	                       |          |      |      |      |        |      |
	                       | regions -|----->+------+------+--------+------+
	                       | cnt      |      [memblock_memory_init_regions]
	                       |          |
	 struct           o--->+----------+
	 memblock         |
	 +-----------+    |
	 |           |    |
	 | memory   -|----o
	 | reserved -|----o
	 |           |    |                      struct memblock_region
	 +-----------+    |    struct            +------+------+--------+------+
	                  |    memblock_type     |      |      |        |      |
	                  o--->+----------+      | Reg0 | Reg1 | ...    | Regn |
	                       |          |      |      |      |        |      |
	                       | regions -|----->+------+------+--------+------+
	                       | cnt      |      [memblock_reserved_init_regions]
	                       |          |
	                       +----------+






       PERCPU


               +------+  +------+           +------+  +------+
               |      |  |      |           |      |  |      |
               | CPU0 |  | CPU1 | ......... | CPUn |  | CPUm |
               |      |  |      |           |      |  |      |
               +------+  +------+           +------+  +------+
                  |          |                 |         |    
                  |          |                 |         |
        o---------o   o------o             o---o         |
        |             |                    |             |
        V             V                    V             V
       +-+-----------+-+-----------+------+-+-----------+-+-----------+
       | |           | |           |      | |           | |           |
       | |           | |           | .... | |           | |           |
       | |           | |           |      | |           | |           |
       +-+-----------+-+-----------+------+-+-----------+-+-----------+
       | <- Area0 -> | <- Area1 -> |      | <- AreaN -> | <- AreaM -> |







       Buddy

       Freelist
       +---+    +---+    +---+             +----+    +----+
       | 0 |<-->| 1 |<-->| 2 |<-->.....<-->| 10 |<-->| 11 |
       +---+    +---+    +---+             +----+    +----+
         A        A                                    A
         |        |                                    |
         V        V                                    V
       +---+    +---+                                +---+
       | P |    | P |                                | P |
       +---+    +---+                                +---+
                  A                                    A
                  |                                    |
                  V                                    V
                +---+                                +---+
                | P |                                | P |
                +---+                                +---+
                 
                  


       Buddy and PCP

       +------+
       |      | PCP/Hot   +---+    +---+    +---+          +---+
       | ZONE |---------->| P |<-->| P |<-->| P |<-->..<-->| P |
       |      |           +---+    +---+    +---+          +---+
       +------+


       Freelist
       +---+    +---+    +---+             +----+    +----+
       | 0 |<-->| 1 |<-->| 2 |<-->.....<-->| 10 |<-->| 11 |
       +---+    +---+    +---+             +----+    +----+
         A                                              A
         | PCP/CLOD                                     |
         V                                              V
       +---+                                          +---+
       | P |                                          | P |
       +---+                                          +---+
                                                        A
                                                        |
                                                        V
                                                      +---+
                                                      | P |
                                                      +---+






         Slub


         +------------+            +----------------+
         |            | cpu_slab   |                |
         | kmem_cache |----------->| kmem_cache_cpu | freelist
         |            |            |                |-----o
         +------------+            +----------------+     |
                                                          |
                                                          |
         o------------------------------------------------o
         |
         V <-------------------------- slab page -----------------------------> |
         +-----+-----+-----+-----+-----+-----+-----+----------+-----+-----+-----+
         |     |     |     |     |     |     |     |          |     |     |     |  
         |     |     |     |     |     |     |     | ........ |     |     |     |  
         |     |     |     |     |     |     |     |          |     |     |     |  
         +-----+-----+-----+-----+-----+-----+-----+----------+-----+-----+-----+
              |  A  |  A  |  A |  A  |  A  |  A  |  A       |  A   |  A   |  A |  
              |  |  |  |  |  | |  |  |  |  |  |  |  |       |  |   |  |   |  | |
              o--o  o--o  o--o o--o  o--o  o--o  o--o       o--o   o--o   o--o o----> NULL






         Kmalloc

    
         kmalloc_caches[]
         +-------------+               +-----------+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
         |  kmalloc-8  |-------------->| Slab page |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
         +-------------+               +-----------+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
         | kmalloc-16  |
         +-------------+               +-----------+-----+-----+-----+-----+-----+-----+-----+-----+--+
         | kmalloc-32  |-------------->| Slab page |     |     |     |     |     |     |     |     |  |
         +-------------+               +-----------+-----+-----+-----+-----+-----+-----+-----+-----+--+
         | kmalloc-64  |
         +-------------+
         | kmalloc-128 |
         +-------------+
         | kmalloc-256 |
         +-------------+
         | kmalloc-512 |
         +-------------+
         | kmalloc-1k  |
         +-------------+              +-----------+-----------------+-----------------+--+--+--+--+--+
         | kmalloc-2k  |------------->| Slab page |                 |                 |  |  |  |  |  |
         +-------------+              +-----------+-----------------+-----------------+--+--+--+--+--+
         | kmalloc-4k  |
         +-------------+
         |   ........  |
         +-------------+
         | kmalloc-16M |
         +-------------+
         | kmalloc-32M |
         +-------------+
         | kmalloc-64M |
         +-------------+



         VMALLOC


         +-----------+---------+------+----+------+----+------+-----+----+
         |           |         |      |    |      |    |      |     |    |
         | Userspace | Normall | HOLE | A0 | HOLE | A1 | Hole | ... |    |
         |           |         |      |    |      |    |      |     |    |
         +-----------+---------+------+----+------+----+------+-----+----+
                                      A    | <--> |<-->|            A
                                      |       A     A               |
                      VMALLOC_START---o       |     |               |
                                              |     |               |
                      GUARD_AREA--------------o     |               |
                                                    |               |
                      VMALLOC_AREA------------------o               |
                                                                    |
                      VMALLOC_END-----------------------------------o
       







                           sysfs_root               sysfs_root_kn
                           +-------------+          +-------------+
                           |             |          |             |
                           |             |          |             |
                           |             | kn       |             | rb
                           | kernfs_root |--------->| kernfs_node |---->
                           |             |          |             |
                           |             |          |             |
                           |             |          |             |
                           +-------------+          +-------------+
                                        A
                                        |
                                        | dir.root
                                        o--------------------o
                                                             |
                                                             |
                     +-----------+        +-------------+    |
                     |           | sd     |             |----o
                     |  name: fs |------->|             |
                     |  kobject  |        | kernfs_node |
                     |           |        |             |
                     +-----------+        |             | 
                                          +-------------+






            Filesystem


                            file_system_type        file_system_type        file_system_type
                            +-----------+           +-----------+           +-----------+
                            |           |           |           |           |           |
                            |           | next      |           | next      |           |
            file_systems--->|   XX_fs   |---------->|  rootfs   |---------->|   sysfs   |----> NULL 
                            |           |           |           |           |           |
                            |           |           |           |           |           |
                            +-----------+           +-----------+           +-----------+






             super_block
             +-------------+                   +-------+     +-------+             +-------+
             |             |         i_sb_list |       |     |       |             |       |
             |    s_inodes |<----------------->| inode |<--->| inode |<--->...<--->| inode |
             |             |                   |       |     |       |             |       |
             |             |                   +-------+     +-------+             +-------+
             |             |
             |             |                   +--------+                        +-------+
             |             |                   |        | d_u.d_alias   i_dentry |       |
             |      s_root |------------------>| dentry |----------------------->| inode |
             |             |                   |        |                        |       |
             |             |                   +--------+                        +-------+
             |             |
             |             |                   +-------+
             |             |      mnt_instance |       |
             |    s_mounts |<----------------->| mount |
             |             |                   |       |
             |             |                   +-------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+



             
             inode
             +-------------+
             |             |
             |             |
             |             |                       +--------+     +--------+             +--------+
             |             | hlist     d_u.d_alias |        |     |        |             |        |
             |   i_dentry  |---------------------->| dentry |<--->| dentry |<--->...<--->| dentry |
             |             |                       |        |     |        |             |        |
             |             |                       +--------+     +--------+             +--------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+




             dentry_hashtable
             +------------------------------------+------+------------------------------------+
             |                                    | head |                                    |
             +------------------------------------+------+------------------------------------+
                                                      A
                                                      |
             struct dentry                            |
             +-------------+                          |
             |             |                          |                 in_lookup_hashtable
             |      d_hash |--------------------------o                 +-------+------+---------------+
             |             |                                            |       | head |               |
             |             |                                            +-------+------+---------------+
             |             |                                                        A
             |             | d_u.d_in_lookup_hash (Parallel)                        |
             |             |--------------------------------------------------------o
             |             |
             |             |
             |             |                            +--------+
             |             |                     Parent |        |
             |     d_child |<-------------------------->| Dentry |
             |             |                            |        |
             |             |                            +--------+
             |             |
             |             |                            +--------+         +--------+
             |             | (subdir dentry)   d_child  |        |         |        |
             |   d_subdirs |<-------------------------->| dentry |<------->| dentry |
             |             |                            |        |         |        |
             |             |                            +--------+         +--------+
             |             |
             |             |                            +-------+
             |             |                   i_dentry |       |
             | d_u.d_alias |--------------------------->| inode |
             |             |                            |       |
             |             |                            +-------+
             |             |
             |             |        +-------------+
             |             |        |             |
             |        d_sb |------->| super_block |            +------------------+
             |             |        |             |            |                  |
             |             |        |      s_type |----------->| file_system_type |
             |             |        +-------------+            |             name |
             |             |                                   +------------------+
             |             |     
             |             |        Parent
             |             |        +--------+
             |             |        |        |
             |    d_parent |------->| dentry |
             |             |        |        |
             |             |        +--------+
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             |             |
             +-------------+




__d_rehash



                                                   -------------------------------------------------------------- ---
                                                                          Application                              A
                                                   --------------------------------------------------------------  |
                                                                     A                    |                        |
                                                                     |                    |                        |
                                                                     |                    V                        |
                                                   --------------------------------------------------------------  |
                                                                           LibC/GLibc                              |
                                                   --------------------------------------------------------------  | Userspace
                                                                     A                    |                        |
                                                                     |                    |                        |
                                                                     |                    V                        |
                                                   --------------------------------------------------------------  |
                                                                            syscall()                              |
                                                   --------------------------------------------------------------  |
                                                                     A                    |                        V
                                                                     |                    |                       ---
                                                                     |                    V                        A
                                                   --------------+----------------------+------------------------  |
                                                                 |                      |                          |
                                                           VFS   | Process Manipulation | Device Manipulation      |            
                                                                 |                      |                          | Kernel-Space
                                                   --------------+----------------------+------------------------  |
                                                        A    |                              A      |               |
                                                        |    |                              |      |               |
                                                        |    V                              |      V               |
                                                     -------------                     -----------------           |
                                                       Real FS                            Hard-Device              V
                                                     -------------                     -----------------          ---








                   open 
                     |                                  Userspace
                   ------------------------------------ syscall
                   SYSCALL_DEFINE3(open, ...)           Kernel
                     |
                     o--> do_sys_open
                            |
                            o--> getname
                                   |
                                   o--> getname_flags
              




              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |
                                               |  |   +--------+
                                               |  |   |  uptr  |
              offsetof(struct filename, iname) |  |   +--------+
                                               |  |   | refcnt |
                                               |  |   +--------+
                                               V  |   |  aname |
                                              --- |   +--------+ <-- iname[]
                                                  |   |        |
                                                  |   |        |
                                         PATH_MAX |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  V   |        |
                                                 ---  +--------+





              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |---o
                                               |  |   +--------+   |
                                               |  |   |  uptr  |   |
              offsetof(struct filename, iname) |  |   +--------+   |
                                               |  |   | refcnt |   |
                                               |  |   +--------+   |
                                               V  |   |  aname |   |
                                              --- |   +--------+ <-o iname[] <-- kname
                                                  |   |        |
                                                  |   |        |
                                         PATH_MAX |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  |   |        |
                                                  V   |        |
                                                 ---  +--------+





              struct filename
                                      
                                              ------  +--------+
                                               A  A   |  name  |
                                               |  |   +--------+
                                               |  |   |  uptr  |
              offsetof(struct filename, iname) |  |   +--------+
                                               |  |   | refcnt |
                                               |  |   +--------+
                                               V  |   |  aname |
                                              --- |   +--------+ <----- iname[0]
                                                  |   |        |  A
                                                  |   +--------+  | <-- iname[1]
                                                  |   |        |  |
                                         PATH_MAX |   |        |  |
                                                  |   |        |  | EMBEDDED_NAME_MAX
                                                  |   |        |  |
                                                  |   |        |  |
                                                  |   |        |  |
                                                  |   |        |  |
                                                  V   |        |  V
                                                 ---  +--------+ ---



                        
                               
              struct filename

                                                 --- +--------+
                                                  A  |  name  |--------------> kname -----> +--------+ ---
                                                  |  +--------+                             |        |  A
                                                  |  |  uptr  |                             |        |  |
                                                  |  +--------+                             |        |  |
              offsetof(struct filename, iname[1]) |  | refcnt |                             |        |  |
                                                  |  +--------+                             |        |  |
                                                  |  |  aname |                             |        |  |
                                                  |  +--------+ <-- iname[0]                |        |  |
                                                  V  |        |                             |        |  | 
                                                 --- +--------+ <-- iname[1]                |        |  | PATH_MAX
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  |
                                                                                            |        |  V
                                                                                            +--------+ ---









                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> build_open_flags


                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> getname


                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> getname
                                                           |
                                                           o--> getname_flags



                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd
                                                                  |
                                                                  o--> expand_files
                                                                         |
                                                                         o--> expand_fdtable
                                                                                |
                                                                                o--> alloc_fdtable




                                           open
                                             |                                  Userspace
                                           ------------------------------------ syscall
                                           SYSCALL_DEFINE3(open, ...)           Kernel
                                             |
                                             o--> do_sys_open
                                                    |
                                                    o--> get_unused_fd_flags
                                                           |
                                                           o--> __alloc_fd
                                                                  |
                                                                  o--> expand_files






                                    | <- 2 * max_fds + ((max_fds / BITS_PER_LONG) + (BITS_PER_LONG -1)) / BITS_PER_LONG -> |
                                    +------------------------------------+-----------------------------------+-------------+
                                    |                                    |                                   |             |
                                    |                                    |                                   |             |
                                    |                                    |                                   |             |
                                    +------------------------------------+-----------------------------------+-------------+
                                    A <-- (max_fds / BITS_PER_BYTE ) --> A <-- (max_fds / BITS_PER_BYTE) --> A <---------> |
                                    |                                    |                                   |
                                    |                                    |                                   |
                                    o--- open_fds        close_on_exec---o               full_fds_bits-------o














                        +-------------------+-------------------------+--------------------+
                        | rwlock reader     |                         | rwlock reader      |
                    +---+-------------------+----+--------------------+---------------+----+
                    | rwlock reader              |                    | rwlock reader |
                    +--------------------+-------+--------------------+---------------+---+
                    | rwlock reader      |                            | rwlock reader     |
                    +-----+--------------+-------+--------------------+-------------------+
                          | spin                 | rwlock writer      |
                          +----------------------+--------------------+


                    ------------------------------------------------------------------------------>
                                                                                            Time







     BiscuitOS MMU Physical Space Layout:

     | <--- 3MB ---> | <-- 1M --> | <-------------------- 64MB ------------------> | <----------- 32MB ------------> |
     +---------------+------------+------------------------------------------------+---------------------------------+
     |               |            |                                                |                                 |
     |    ZONE_DMA   | ZONE_DMA32 |                   ZONE_NORMAL                  |           ZONE_HIGHMEM          |
     |               |            |                                                |                                 |
     +---------------+------------+------------------------------------------------+---------------------------------+
     A               A            A                                                A                                 A
     |               |            |                                                |                                 |
     |               |            o-- 0x70400000                                   |                                 |
     |               o-- 0x70300000                                                |                                 |
     o-- PHYS_OFFSET/0X70000000                                                    o-- 0x74400000      0x76400000 ---o
   



     BiscuitOS MMU Physical Space Layout:

     | <---------- 4MB ---------> | <-------------------- 64MB ------------------> | <----------- 32MB ------------> |
     +----------------------------+------------------------------------------------+---------------------------------+
     |                            |                                                |                                 |
     |          ZONE_DMA          |                   ZONE_NORMAL                  |           ZONE_HIGHMEM          |
     |                            |                                                |                                 |
     +----------------------------+------------------------------------------------+---------------------------------+
     A                            A                                                A                                 A
     |                            |                                                |                                 |
     |                            o-- 0x70400000                                   |                                 |
     |                                                                             |                                 |
     o-- PHYS_OFFSET/0X70000000                                                    o-- 0x74400000      0x76400000 ---o
   


     BiscuitOS MMU Virtual Space Layout:


     | <--------------- 68MB ---------------> |      | <------------ 26MB ------------> |      | <--- 2MB ----> |
     +----------------------------------------+------+----------------------------------+------+----------------+------+--------+-+
     |                                        |      |                                  |      |                |      |        | |
     |          Linear Mapping Space          | Hole |           VMALLOC Space          | Hole |   Kmap Space   | Hole | FIXMAP | | 
     |                                        |      |                                  |      |                |      |        | |
     +----------------------------------------+------+----------------------------------+------+----------------+------+--------+-+
     A                                        A      A                                  A      A                A      A        A
     |                                        |      |                                  |      |                |      |        |
     |                                        |      |                                  |      |                |      |        o-- FIXADDR_TOP/0x963FF000
     |                                        |      o-- VMALLOC_START/0x9440A000       |      |                |      o----------- FIXADDR_START/0x96395000
     o-- PAGE_OFFSET/0x90000000               o--------- high_memory/0x94400000         |      |                o------------------ PKMAP_ADDR(LAST_PKMAP)/0x96200000
                                                                                        |      o-- PKMAP_BASE/0x96000000
                                                                                        o--------- VMALLOC_END/0x95E0A000



    Linux Virtual Address




    ERROR AREA   Userspace                                                              Kernel Space
     |<--->| <---------------> |                  | <-------------------------------------------------------------------------------------------> |
     +----------------------------------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     |                         |        |  PKMAP  |    |       |  | Kernel Image |                 |     |   VMALLOC AREA   |  |   FIXMAP   |  |  |
     |                         |        |         |    |       |  |              |                 |     |                  |  |            |  |  |
     +-------------------------+--------+---------+----+-------+--+--------------+-----------------+-----+------------------+--+------------+--+--+
                               A        A         A    A <---> |  A              A <- lowmemory -> | <-> |                  A  A            A  A
                               |        |         |    |   A      |              |                 A  A  A                  |  |            |  |
                               |        |         |    |   |      |              |                 |  |  |                  |  |            |  o-- FIXADDR_END(0xfff00000UL)
                               |        |         |    |   |      |              |                 |  |  |                  |  |            o----- FIXADDR_TOP
     TASK_SIZE ----------------o        |         |    |   |      |              |                 |  |  |                  |  o------------------ FIXADDR_START(0xffc00000UL)
     PKMAP_BASE ------------------------o         |    |   |      |              |                 |  |  |                  |
                              PAGE_OFFSET --------o    |   |      |              |                 |  |  |                  o--- VMALLOC_END(0xff800000UL)
                              swapper_pg_dir ----------o   |      |              |                 |  |  o---------------------- VMALLOC_START
                              Kernel page table directory -o      |              |                 |  o------------------------- VMALLOC_OFFSET(8M)
                              KERNEL_START/_stext ----------------o              |                 o---------------------------- high_memory
                              KERNEL_END/_end -----------------------------------o










       Bootmem

       +-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |.|.|.| | | | |.|.|.| | | ..... | | | | |.|.|.|.| | ...... | | | | | |.|.|.|.| | | | |.|.|
       +-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       A
       |
       |
       o-- NODE_DATA(0)->bdata->node_bootmem_map

       o-- NODE_DATA(0)->bdata->node_boot_start
       |
       |
       V <-------------------- Physical RAM -----------------> |
       +---------------------------+---------------------------+
       |                           |                           |
       |      meminfo.bank[0]      |      meminfo.bank[1]      |
       |                           |                           |
       +---------------------------+---------------------------+
                                   A
                                   |
                                   |
                                   o-- NODE_DATA(0)->bdata->node_low_pfn















                       start_kernel_bs
                          |
                          o-- setup_arch_bs
                                 |
                                 o-- paging_init_bs
                                        |
                                        o-- bootmem_init_bs



                      start_kernel_bs
                         |
                         o-- setup_per_cpu_areas_bs





                PERCPU Static [Linux 2.6.x]

                +---------+---------+------------------------------------------------------+
                |         |         |                                                      |
                |         | .percpu |                                                      |
                |         |         |                                                      |
                +---------+---------+------------------------------------------------------+
                |         A         A
                |         |         |
                |         |         o-- __per_cpu_end
                |         o------------ __per_cpu_start
                |
                | Bootmem
                |
                V                   | <- __per_cpu_offset -> |
                +---------+---------+------------------------+-------------+---------------+
                |         |         |                        |             |               |
                |         | .percpu |                        | PERCPU AREA |               |
                |         |         |                        |             |               |
                +---------+---------+------------------------+-------------+---------------+



                PERCPU Allocator[Linux 2.6.x]
                             
                struct percpu_data                                  
                +-----------------+               +---------+              +------+
                | ptrs[0]         |-------------->| Data[0] |<-------------| CPU0 |
                +-----------------+               +---------+              +------+
                | ptrs[1]         |-------------->| Data[1] |<-------------| CPU1 |
                +-----------------+               +---------+              +------+
                | .......         |
                +-----------------+               +---------+              +------+
                | ptrs[NR_CPUS-1] |-------------->| Data[n] |<-------------| CPUn |
                +-----------------+               +---------+              +------+
                | blkp            |
                +-----------------+








                struct zone
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+







                | <- PAGE_SIZE -> | <- PAGE_SIZE -> |                 | <- PAGE_SIZE -> | <- PAGE_SIZE -> |
                +-----------------+-----------------+-----------------+-----------------+-----------------+
                |                 |                 |                 |                 |                 |
                |     Region0     |     Region1     |     .......     |     RegionM     |     RegionN     |
                |                 |                 |                 |                 |                 |
                +-----------------+-----------------+-----------------+-----------------+-----------------+
                A <--- Fram0 ---> | <--- Fram1 ---> |                 | <--- FramM ---> | <--- FramN ---> |
                |
                |
                o-- PHYS_OFFSET: [Start address of RAM]







                PhysAddr:
                32/64                            PAGE_SHIFT                 0
                +--------------------------------+--------------------------+
                |           Page Frame           |                          |
                +--------------------------------+--------------------------+
                                                 | <----- PAGE_SHIFT -----> |





                +----------------------------------------------------------+
                |                        Page Set                          |
                +----------------------------------------------------------+
                                            |
                                            |
                                            V
                +-----------------------------------+ +-------------+ +-------+
                | Page0.Page1.Page2.....Page2^(n-1) | | Page0.Page1 | | Page0 |
                +-----------------------------------+ +-------------+ +-------+



                                         +----------------------+
                                         | Page0.Page1....PageN |
                                         +----------------------+
                                                   |
                                                   | Insert 
                                                   | 
                                                   V
                +----------------+       +----------------------+
                | free_area[m]   | <---> | Page0.Page1....PageN |
                +----------------+       +----------------------+
                | free_area[m+1] |
                +----------------+



                +----------------+       +----------------------+   no-Buddy   +----------------------+
                | free_area[m]   | <---> | Page0.Page1....PageN | <----------> | Page0.Page1....PageN |
                +----------------+       +----------------------+              +----------------------+
                | free_area[m+1] |
                +----------------+



                +----------------+   
                | free_area[m]   | 
                +----------------+       +-----------------------------------------------+
                | free_area[m+1] | <---> | Page0.Page1.....PageN.Page(N+1).........PageM |
                +----------------+       +-----------------------------------------------+





                +---------------------+ ------------------------
       PageSet0 | Page0.Page1...PageN |                 A  A  A
                +---------------------+                 |  |  | Buddy
       PageSet1 | Page0.Page1...PageN |                 |  |  V
                +---------------------+ ----------------|--|----
       PageSet2 | Page0.Page1...PageN |                 |  | Buddy
                +---------------------+                 |  |
       PageSet3 | Page0.Page1...PageN |                 |  V
                +---------------------+ ----------------|---
       PageSet4 | Page0.Page1...PageN |                 |
                +---------------------+                 |
       PageSet5 | Page0.Page1...PageN |                 | Buddy
                +---------------------+                 |
       PageSet6 | Page0.Page1...PageN |                 |
                +---------------------+                 |
       PageSet7 | Page0.Page1...PageN |                 V
                +---------------------+ -----------------



                Buddy-DMA: ZONE_DMA
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-DMA32: ZONE_DMA32
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-Normal: ZONE_NORMAL
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                Buddy-HighMem: Zone_HighMem
                +--------------+
                |              |
                +--------------+             +------+      +------+      +------+      +------+
                | free_area[0] | <---------> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ....
                +--------------+             +------+------+------+------+------+      +------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+




                
                                +----------+
               ZONE_DMA <-----> | ZONE_DMA |
                                +----------+

                                +------------+        +----------+
               ZONE_DMA32 <---> | ZONE_DMA32 | <----> | ZONE_DMA |
                                +------------+        +----------+

                                +-------------+       +------------+       +----------+
               ZONE_NORMAL <--> | ZONE_NORMAL | <---> | ZONE_DMA32 | <---> | ZONE_DMA |
                                +-------------+       +------------+       +----------+

                                +--------------+      +-------------+      +------------+      +----------+
               ZONE_HigMem <--> | ZONE_HighMem | <--> | ZONE_NORMAL | <--> | ZONE_DMA32 | <--> | ZONE_DMA |
                                +--------------+      +-------------+      +------------+      +----------+






                struct zone
                +--------------+
                |              |
                +--------------+             +-------+      +-------+
                | free_area[0] | <---------> | Page0 | <--> | Page0 | <--> ..
                +--------------+             +-------+-----++-------+-+-----------+      
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+



                struct zone
                +--------------+
                |              |
                +--------------+
                | free_area[0] |
                +--------------+             +-------------+      +-------------+
                | free_area[1] | <---------> | Page0.Page1 | <--> | Page0.Page1 | <--> ..
                +--------------+             +-------------+------+----+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          | 
                                                          V

                struct zone
                +--------------+                                     +-------+
                |              |                                     | Page0 | -----> requestor
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+   
                | free_area[1] | <---------> | Page0.Page1 | <--> ..
                +--------------+             +-------------+-----------+------+-------------------------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | <--> | Page0.Page1.Page2.Page3 | <--> ..
                +--------------+             +-------------------------+      +-------------------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] | <--> ....
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+





                struct zone
                +--------------+
                |              |
                +--------------+
                | free_area[0] |
                +--------------+ 
                | free_area[1] | 
                +--------------+ 
                | free_area[2] | 
                +--------------+ 
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          |
                                                          V

                struct zone
                +--------------+                                     +-------+
                |              |                                     | Page0 | -----> requestor
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+
                | free_area[1] | <---------> | Page0.Page1 | 
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 | 
                +--------------+             +-------------------------+
                | .......      |
                +--------------+           
                | free_area[m] | 
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+





                struct zone
                +--------------+                                   +------+
                |              |                                   | Page | <--- Free
                +--------------+                                   +------+
                | free_area[0] | 
                +--------------+            
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                          |
                                                          |
                                                          |
                                                          V


                struct zone
                +--------------+
                |              |
                +--------------+             +-------+
                | free_area[0] | <---------> | Page0 |
                +--------------+             +-------+
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+






                struct zone
                +--------------+                                     +-------+
                |              |              "Buddy"                | Page0 | <--- Free
                +--------------+             +-------+               +-------+
                | free_area[0] | <---------> | Page1 |
                +--------------+             +-------+-----+
                | free_area[1] | <---------> | Page0.Page1 |
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 |
                +--------------+             +-------------------------+
                | .......      |
                +--------------+
                | free_area[m] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                            |
                                                            |
                                                            V

                struct zone
                +--------------+                                   
                |              |                                   
                +--------------+                                      +-------------+
                | free_area[0] |              "Buddy"                 | Page0.Page1 |
                +--------------+             +-------------+          +-------------+
                | free_area[1] | <---------> | Page0.Page1 |
                +--------------+             +-------------+-----------+
                | free_area[2] | <---------> | Page0.Page1.Page2.Page3 |
                +--------------+             +-------------------------+
                | .......      |
                +--------------+
                | free_area[m] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+

                                                            |
                                                            |
                                                            V

                struct zone
                +--------------+                                  
                |              |                                 
                +--------------+                                  
                | free_area[0] |
                +--------------+
                | free_area[1] |
                +--------------+
                | free_area[2] |
                +--------------+
                | .......      |
                +--------------+             +--------------------------------------------+
                | free_area[m] | <---------> | Page0.Page1.Page2.Page3.......Page[2^m -1] |
                +--------------+             +--------------------------------------------+------------+
                | free_area[n] | <---------> | Page0.Page1.........Page[2^m - 1]..........Page[2^n -1] | <--> ...
                +--------------+             +---------------------------------------------------------+



                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+      +------+      +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> | Page | <--> | Page | <--> ..
                +--------------+         +------+      +------+      +------+      +------+
                |              |
                +--------------+


                struct zone
                +--------------+
                |              |
                +--------------+         +------+ 
                | Page0List    | <-----> | Page | 
                +--------------+         +------+ 
                |              |
                +--------------+


                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+       N Page       +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> ........ <--> | Page |
                +--------------+         +------+      +------+                    +------+
                |              |
                +--------------+





                struct zone
                +--------------+
                |              |
                +--------------+         +------+      +------+      +------+      +------+
                | Page0List    | <-----> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+         +------+      +------+      +------+      +------+
                |              |         | <---------------- M Page --------------------> |
                +--------------+



                struct zone
                +--------------+
                |              |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                |              |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | Page0List    | -----+              
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                                      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                                                    +------+      +------+      +------+      +------+
                                                    | <---------------- M Page --------------------> |







                struct zone
                +--------------+
                |              |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                |              |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | Page0List    | -----+        
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                | Page1List    |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+                    +------+      +------+      +------+      +------+
                | Page2List    |                    | <---------------- M Page --------------------> |
                +--------------+
                | ............ |                    | <---------------- M Page --------------------> |
                +--------------+           Hot      +------+      +------+      +------+      +------+
                | PageMList    |      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                +--------------+      |             +------+      +------+      +------+      +------+
                | PageNList    | -----+        
                +--------------+      |    Cold     +------+      +------+      +------+      +------+
                                      o-----------> | Page | <--> | Page | <--> | Page | <--> | Page |
                                                    +------+      +------+      +------+      +------+
                                                    | <---------------- M Page --------------------> |










                               start_kernel_bs
                                  |
                                  o-- setup_arch_bs
                                  |      |
                                  |      o-- paging_init_bs
                                  |             |
                                  |             o-- free_area_init_node_bs
                                  |                    |
                                  |                    o-- calculate_zone_totalpages_bs
                                  |                    |
                                  |                    o-- alloc_node_mem_map_bs
                                  |                    |
                                  |                    o-- free_area_init_core_bs
                                  |                           |
                                  |                           o-- memmap_init_bs
                                  |                           |
                                  |                           o-- zone_init_free_lists_bs
                                  |
                                  o-- build_all_zonelists_bs
                                  |      |
                                  |      o-- build_zonelists_bs
                                  |
                                  o-- mem_init_bs
                                         |
                                         o-- free_all_bootmem_node_bs
                                                |
                                                o-- free_all_bootmem_core_bs




                struct zone
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ... 
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ... 
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+








                PCP: ZONE_DMA
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+


                PCP: ZONE_DMA32
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+





                PCP: ZONE_NORMAL
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+



                PCP: ZONE_HIGHMEM
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                |                    |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[0]         |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                | pageset[1]         |            o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+                             +--------+      +------+      +------+      +------+
                | pageset[2]         |
                +--------------------+
                | pageset[3]         |
                +--------------------+
                | .................. |
                +--------------------+
                | pageset[NR_CPUS-3] |
                +--------------------+                 Hot         +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-2] |            o--------------> | pcp[0] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                +--------------------+            |                +--------+      +------+      +------+      +------+
                | pageset[NR_CPUS-1] |-----------(+)
                +--------------------+            |    Cold        +--------+      +------+      +------+      +------+
                                                  o--------------> | pcp[1] | <--> | Page | <--> | Page | <--> | Page | <--> ...
                                                                   +--------+      +------+      +------+      +------+









                    
                    A
                    |
                    |                                     free             
                    |                                     .
               high |-------------------------------------.-------------
                    |..                                 .
                    |  .                  ...          .   ...
                    |   .      ......        .        .       .
                    |    .    .      .        .      .         ...
                    |     ....        .        ......
                    |                  .
                low |-------------------.-------------------------------           
                    |                    .
                    |                    alloc
                    |
                    +-------------------------------------------------->






                    vmalloc_bs()
                       |
                       o--> __vmalloc_bs
                               |
                               o--> get_vm_area_bs
                               |       |
                               |       o--> __get_vm_area_bs
                               |        
                               o--> __vmalloc_area_bs
                                       |
                                       o--> alloc_page_bs
                                       |
                                       o--> map_vm_area_bs
                                               |
                                               o--> vmap_pud_range_bs
                                                       |
                                                       o--> vmap_pmd_range_bs
                                                               |
                                                               o--> vmap_pte_range_bs
                                                                       |
                                                                       o--> set_pte_at_bs       






                    vfree_bs()
                       |
                       o--> __vunmap_bs
                               |
                               o--> remove_vm_area_bs
                               |       |
                               |       o--> __remove_vm_area_bs
                               |              |
                               |              o--> unmap_vm_area_bs
                               |                      |
                               |                      o--> vunmap_pud_range_bs
                               |                              |
                               |                              o--> vunmap_pmd_range_bs
                               |                                      |
                               |                                      o--> vunmap_pte_range_bs
                               |                                              |
                               |                                              o--> ptep_get_and_clear_bs
                               |
                               o--> __free_page_bs






                                              VMALLOC_START                               VMALLOC_END
                                              |                                           |
                                       +------+--+----+---+----+---+----+----------+----+-+----------+
                                       |      |  |    |   |    |   |    |          |    | |          |
                                       | .... |  | A0 |   | A1 |   | A2 |          | A3 | |   .....  |
                                       |      |  |    |   |    |   |    |          |    | |          |
                                       +------+--+----+---+----+---+----+----------+----+-+----------+
                                                   A         A        A               A
                                                   |         |        |               |
                                                   |         o-----o  |               |
                       vmlist                      |               |  |               |
                       +--------+      +--------+--o   +--------+--o  o+--------+     o+--------+
                       |        |      |        |      |        |      |        |      |        |
                       +--------+      +--------+      +--------+      +--------+      +--------+
                       |   next |----->|   next |----->|   next |----->|   next |----->|   next |
                       +--------+      +--------+      +--------+      +--------+      +--------+
                       |        |      |        |      |        |      |        |      |        |
                       +--------+      +--------+      +--------+      +--------+      +--------+




                               VMALLOC Virutal Address
                               64/32                                               12                    0
                               +------------+------------+------------+------------+---------------------+
                               | PGD_Offset | PUD_Offset | PMD_Offset | PTE_OFFSET |                     |
                               +------------+------------+------------+------------+---------------------+


                             
                               VMALLOC Virutal Address
                               64/32                                                            12       0
                               +------------+------------+------------+------------+------------+--------+
                               | PGD_Offset | P4D_Offset | PUD_Offset | PMD_Offset | PTE_Offset |        |
                               +------------+------------+------------+------------+------------+--------+






                               pkmap_count[LAST_PKMAP]

                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               |+| | | | | | | | |+| | | | | | | ..... | | | | | | | | | |+|+| | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |       | | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                A                                                                         A
                                |                                                                         |
                                |                                                                         |
                                o-- PKMAP_ADDR(0)                              PKMAP_ADDR(LAST_PKMAP-1) --o







                                kmap_high_bs
                                   |
                                   o--> page_address_bs()
                                   |
                                   o--> map_new_virtual_bs()
                                           |
                                           o--> pkmap_count_bs[]
                                           |
                                           o--> PKMAP_ADDR_BS
                                           |
                                           o--> set_pte_at_bs
                                           |
                                           o--> set_page_address_bs
                                                   |
                                                   o--> page_slot_bs
                                                   |
                                                   o--> list_entry(page_address_pool_bs.next)




                                 kunmap_high_bs()
                                    |
                                    o--> page_address_bs()
                                            |
                                            o--> PKMAP_NR_BS()
                                            |
                                            o--> --pkmap_count[]


                               FIXADDR_TOP                                                                FIXADDR_END
                               |                         | <-FIX_KMAP-> |                                 |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | |+| | | | | | | | | | | | .....  | | | | | | | | | | | |+| | |+| | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               A A A A A A A A A A A     A              A                   A A A A A A A
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              |                   | | | | | | |
                               | | | | | | | | | | |     |              o-- FIX_KMAP_END    | | | | | | |
                               | | | | | | | | | | |     o----------------- FIX_KMAP_BEGIN  | | | | | | o-- FIX_WP_TEST
                               | | | | | | | | | | |                                        | | | | | o---- FIX_BTMAP_END
                               | | | | | | | | | | |                                        | | | | o------ ...
                               | | | | | | | | | | o-------  FIX_F00F_IDT                   | | | o-------- FIX_BTMAP_BEGIN
                               | | | | | | | | | o---------- FIX_LI_PCIB                    | | o---------- FIX_ACPI_END
                               | | | | | | | | o------------ FIX_LI_PCIA                    | o------------ ...
                               | | | | | | | o-------------- FIX_CO_APIC                    o-------------- FIX_ACPI_BEGIN
                               | | | | | | o---------------- FIX_CO_CPU
                               | | | | | o------------------ FIX_IO_APIC_BASE_END
                               | | | | o-------------------- ...
                               | | | o---------------------- FIX_IO_APIC_BASE_0
                               | | o------------------------ FIX_APIC_BASE
                               | o-------------------------- FIX_VSYSCALL
                               o---------------------------- FIX_HOLE  
                               
                         


                               FIX_KMAP_BEGIN                                                             FIX_KMAP_END
                               |                                                                          |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | |+| | | | | | | | | | | | .....  | | | | | | | | | | | |+| | |+| | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               | | | | | | | | | | | | | | | | |        | | | | | | | | | | | | | | | | | |
                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               A A A A A A A A A A A A A A A A                                      A A A 
                               | | | | | | | | | | | | | | | |                                      | | |
                               | | | | | | | | | | | | | | | |                                      | | |
                               | | | | | | | | | | | | | | | |                          ----        | | |
                               | | | | | | | | | | | | | | | |                            A         | | o------ KM_SOFTIRQ1  ----
                               | | | | | | | | | | | | | | | |                            |         | o-------- KM_SOFTIRQ0    A
                               | | | | | | | | | | | | | | | |                            .         o---------- KM_IRQ1        |
                               | | | | | | | | | | | | | | | |                            . CPU1                               .
                               | | | | | | | | | | | | | | | |                            .                                    . CPUn
                               | | | | | | | | | | | | | | | o-- KM_SKB_DATA_SOFTIRQ      |                                    .
                               | | | | | | | | | | | | | | o---- KM_SKB_SUNRPC_DATA       V                                    |
                               | | | | | | | | | | | | | o------ KM_BOUNCE_READ         ----                                   V
                               | | | | | | | | | | | | o-------- KM_SOFTIRQ1              A                                  ----
                               | | | | | | | | | | | o---------- KM_SOFTIRQ0              |
                               | | | | | | | | | | o------------ KM_IRQ1                  |
                               | | | | | | | | | o-------------- KM_IRQ0                  |
                               | | | | | | | | o---------------- KM_PTE1                  |
                               | | | | | | | o------------------ KM_PTE0                  | CPU0
                               | | | | | | o-------------------- KM_BIO_DST_IRQ           |
                               | | | | | o---------------------- KM_BIO_SRC_IRQ           |
                               | | | | o------------------------ KM_USER1                 |
                               | | | o-------------------------- KM_USER0                 |
                               | | o---------------------------- KM_SKB_DATA_SOFTIRQ      |
                               | o------------------------------ KM_SKB_SUNRPC_DATA       V
                               o-------------------------------- KM_BOUNCE_READ         ----












                             kmap_atomic_bs()                  kunmap_atomic_bs()
                                |                                 |
                                o-- inc_preempt_count()           o-- dec_preempt_count()
                                |                                 |
                                o-- page_address_bs()             o-- __fix_to_virt_bs()
                                |                                 |
                                o-- __fix_to_virt_bs()            o-- pte_clear_bs()
                                |                                 |
                                o-- set_pte_bs/mk_pte_bs          o-- __flush_tlb_one_bs()
                                |
                                o-- __flush_tlb_one_bs()




                            0                                                                              
                            +---------------+-----------------------------------------------------------------------------+
                            |               |                                                                             |
                            | Request Bytes |                               Waste Bytes                                   |
                            |               |                                                                             |
                            +---------------+-----------------------------------------------------------------------------+
                            | <------------------------------------- PAGE_SIZE -----------------------------------------> |









                                            +--------------------------+
                                            |           CPU            |
                                            |      Register/Cache      |
                                            +--------------------------+
                                                         A
                                                         |
                                                         V
                           +------------------------------------------------------------+
                           |                           Memory                           |
                           +------------------------------------------------------------+
                                   A                     A                  A
                                   |                     |                  |
                                   V                     V                  V
                              +---------+           +--------+          +--------+
                              | SSD/HDD | ........  | CD-ROM | ........ | Floppy |
                              +---------+           +--------+          +--------+




                                                    
                                                    +------------------------------------------------------------------------+
                                                    |                                                                        |
                                                    |                               Memory                                   |
                                                    |                                                                        |
                                                    +------------------------------------------------------------------------+
                                                    A
                                                    |
                                                    |
                                                   (+)-------(+)----------------(+)-------------- Address Bus
                                                              A                  |
                                                              |                  |
                                                              |                  V
                                                         +---------+       +-----------+
                                                         |   CPU   |       | Interrupt |
                                                         +---------+       +-----------+





                                                   32bit-Mechine
                                                   0                                              2^32
                                                   +----------------------------------------------+
                                                   |                                              |                           
                                                   |                                              |                           
                                                   |                                              |                           
                                                   +----------------------------------------------+
 
                                                   64bit-Mechine
                                                   0                                                                             2^64
                                                   +-----------------------------------------------------------------------------+
                                                   |                                                                             |
                                                   |                                                                             |
                                                   |                                                                             |
                                                   +-----------------------------------------------------------------------------+









                                                   0 
                                                   +------------+-+-------------------------------------------------------------+
                                                   |            | |                                                             |
                                                   |            | |               Virtual Space                                 |
                                                   |            | |                                                             |
                                                   +------------+-+-------------------------------------------------------------+
                                                                 |
                                                                 V
                                                   +-----------------------------+
                                                   |            MMU(on)          |
                                                   +-----------------------------+
                                                                 |
                                                                 o--------------------o
                                                                                      |
                                                                                      V 
                                                   +---------------------------------+-+---------+
                                                   |                                 | |         |
                                                   |        Physcial Space           | |         |
                                                   |                                 | |         |
                                                   +---------------------------------+-+---------+





                                                   0
                                                   +------------+-+-------------------------------------------------------------+
                                                   |            | |                                                             |
                                                   |            | |               Physical Space                                |
                                                   |            | |                                                             |
                                                   +------------+-+-------------------------------------------------------------+
                                                                 |
                                                                 V
                                                   +-----------------------------+
                                                   |            MMU(on)          |
                                                   +-----------------------------+
                                                                 |
                                                                 V






                                                                                                                          +-----------------+
                                                   +------------+------------+------------+------------+-------------+    |                 |
                                                   | PGD_OFFSET | PUD_OFFSET | PMD_OFFSET | PTE_OFFSET | PAGE_OFFSET |    +-----------------+
                                                   +------------+------------+------------+------------+-------------+    |                 |
                                                         |               |             |             |             |      +-----------------+
                                                         |               |             |             |             o----->|                 |
                                                         |               |             |             |                    +-----------------+
                                                         |   +--------+  |   +------+  |             |   +-----+          |                 |
                                                         |   |        |  |   |      |  |             |   |     |          +-----------------+
                                                         |   +--------+  |   +------+  |   +-----+   |   +-----+          |                 |
                                                         o-->|        |-(+)->|      |-(+)->|     |->(+)->|     |--------->+-----------------+
                                                             +--------+      +------+      +-----+       +-----+
                                                             | ...... |      |      |      |     |       |     |
                                                     PGTable +--------+      +------+      +-----+       +-----+
                                                                             | .... |      |     |       |     |
                                                                    PUDTable +------+      +-----+       +-----+
                                                                                           | ... |       |     |
                                                                                  PMDTable +-----+       +-----+
                                                                                                         | ... |
                                                                                                PTETable +-----+








                                                   Virtual Address                                                                                        +--------------------+
                                                   64/32                                                                                            0     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                       |                      |                      |                      |                     |       |                    |
                                                       |                      |                      |                      |                     |       +--------------------+
                                                       |                      |                      |                      |    +-------------+  o------>|                    | 
                                                       |                      |                      |                      |    | ........... |          +--------------------+
                                                       |                      |                      |                      |    +-------------+          |                    |
                                                       |                      |                      |    +-------------+   o--->|             |--------->+--------------------+
                                                       |                      |                      |    | ........... |        +-------------+
                                                       |                      |                      |    +-------------+        | ........... |
                                                       |                      |    +-------------+   o--->|             |------->+-------------+
                                                       |                      |    | ........... |        +-------------+        PTE Table
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable



                                                 Virtual Space
                                                 0
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                                     A
                                                                     |
                                                 MMU                 V
                                                 +-------------------------------------------+
                                                 |                Page Table                 |
                                                 +-------------------------------------------+
                                                                     A
                                                                     |
                                                 Physical Space      |
                                                 0                   V
                                                 +------------------------------------------------------+
                                                 |                                                      |
                                                 |                                                      |
                                                 |                                                      |
                                                 +------------------------------------------------------+




                                                 Virtual Space
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 | | | | | | | | ..... | | | | | | |                                      
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Initialize
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Allocating
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               |
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|1|1|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               V
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+


                                                 Virtual Memory Allocator: Freeing
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               A
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               |
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+




                                                 Physical Space      |
                                                 0                   V
                                                 +-------+-------+-------+-------+-----------------+-------+-------+-------+-------+
                                                 |       |       |       |       |                 |       |       |       |       |
                                                 | Page0 | Page1 | Page2 | Page3 | ............... | PageN | PageM | PageY | PageZ |
                                                 |       |       |       |       |                 |       |       |       |       |
                                                 +-------+-------+-------+-------+-----------------+-------+-------+-------+-------+



                                                 Virtual Space
                                                 32Bit-Mechine
                                                 0                                                                                                 2^32
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+


                                                 64Bit-Mechine
                                                 0                                                                                                 2^64
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+






                                                 Physical Memory Allocator: Initialize
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+


                                                 Physical Memory Allocator: Allocating
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               |
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|1|1|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               V
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+



                                                 Physical Memory Allocator: Freeing
                                                 0
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                                               A
                                                 Bitmap                                        |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|           |
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+           |
                                                                                               |
                                                                                               +---------+---------+
                                                                                               |         |         |
                                                                                               | Region3 | Region4 |
                                                                                               |         |         |
                                                                                               +---------+---------+







                                                
                                                 Virtual Space
                                                 V_START
                                                 | <------------ Linear Mapping Area ------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |                                                 |
                                                 |                                                 |
                                                 |                                                 |
                                                 V                                                 V
                                                 +---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 |
                                                 |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+
                                                 P_START
                                                 Physical Space


                                                 V_START = K + P_START



                                                 Virtual Space

                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                                          |        |
                                                      o-------------------o        o---------o
                                                      |                                      |
                                                      |                                      |
                                                      V                                      V
                                                 +---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 |
                                                 |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+

                                                 Physical Space




                                                 Virtual Space
                                                 
                                                 +-----------+--------+--------+-------------------------------------------------------------------+
                                                 |           |        |        |                                                                   |
                                                 | PageTable | Bitmap | Bitmap |                                                                   |
                                                 |           |        |        |                                                                   |
                                                 +-----------+--------+--------+-------------------------------------------------------------------+
                                                 |                             |                    
                                                 | <----- Linear Mapping ----> |
                                                 V                             V
                                                 +-----------------------------+------------------------+
                                                 |                             |                        |
                                                 |                             |                        |
                                                 |                             |                        |
                                                 +-----------------------------+------------------------+
                                                 
                                                 Physical Space








                                                 Virtual Space

                                                 +-----------+--------+--------+---------+---------+---------+---------+-----------------+---------+
                                                 |           |        |        |         |         |         |         |                 |         |
                                                 | PageTable | Bitmap | Bitmap | Region0 | Region1 | Region2 | Region3 | ............... | RegionN |
                                                 |           |        |        |         |         |         |         |                 |         |
                                                 +-----------+--------+--------+---------+---------+---------+---------+-----------------+---------+
                                                 |                             |                                                                   |
                                                 | <----- Linear Mapping ----> | <------------------------- Cross Mapping -----------------------> |
                                                 V                             V
                                                 +-----------------------------+---------+----+---------+
                                                 |                             |         |    |         |
                                                 |                             | Region0 | .. | RegionM |
                                                 |                             |         |    |         |
                                                 +-----------------------------+---------+----+---------+

                                                 Physical Space





                                                 Kernel --> | Arch Init | --> | kernel init |



                                                 Virtual Space
                                                 BISCUITOS_PAGE_OFFSET
                                                 0x90000000                                                                                        0x96400000
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                 | <---------------------------------- BISCUITOS_MEMORY_SIZE ------------------------------------->|

                                                 Physcial Space
                                                 BISCUITOS_RAM_BASE
                                                 0x70000000                                                                                        0x76400000
                                                 +-------------------------------------------------------------------------------------------------+
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 |                                                                                                 |
                                                 +-------------------------------------------------------------------------------------------------+
                                                 | <----------------------------------- BISCUITOS_RAM_SIZE --------------------------------------->|







                                                 Virtual Space
                                                 BISCUITOS_PAGE_OFFSET
                                                 0x90000000                                                                                        0x96400000
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 | <---------------------------------- BISCUITOS_MEMORY_SIZE ------------------------------------> |
                                                 |                             A
                                                 | <-- Linear Mapping Area --> | <------------------ Non-Linear Mapping Area --------------------> |
                                                 Physcial Space                |
                                                 BISCUITOS_RAM_BASE            |
                                                 0x70000000                    V                                                                    0x76400000
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 |                             |                                                                   |
                                                 +-----------------------------+-------------------------------------------------------------------+
                                                 | <----------------------------------- BISCUITOS_RAM_SIZE --------------------------------------> |







                                                Virtual Linuear Space

                                                0x90000000
                                                | <---------------------------- BISCUITOS_LINEAR_SIZE ------------------------------> |
                                                +------+----------------+------+---------------------------+--------------------------+
                                                |      |                |      |                           |                          |
                                                | HOLE | PTE TABLE Area | HOLE | Physical Allocator Bitmap | Virtual Allocator Bitmap |
                                                |      |                |      |                           |                          |
                                                +------+----------------+------+---------------------------+--------------------------+
                                                A      A                       A                           A
                                                |      |                       |                           |
                                                |      |                       |                           o-- BISCUITOS_BITMAP_VIRT
                                                |      |                       o------------------------------ BISCUITOS_BITMAP_PHYS
                                                |      o-- BISCUITOS_PTETABLE_BASE
                                                o--------- BISCUITOS_PAGE_OFFSET
                                                 


 






                                                   Virtual Address                                                                                        +--------------------+
                                                   64/32                                                                                            0     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |     |                    |
                                                   +------------------+------------------+------------------+------------------+--------------------+     +--------------------+
                                                       |                      |                      |                      |                     |       |                    |
                                                       |                      |                      |                      |                     |       +--------------------+
                                                       |                      |                      |                      |    +-------------+  o------>|                    |
                                                       |                      |                      |                      |    | ........... |          +--------------------+
                                                       |                      |                      |                      |    +-------------+          |                    |
                                                       |                      |                      |    +-------------+   o--->|             |--------->+--------------------+
                                                       |                      |                      |    | ........... |        +-------------+
                                                       |                      |                      |    +-------------+        | ........... |
                                                       |                      |    +-------------+   o--->|             |------->+-------------+
                                                       |                      |    | ........... |        +-------------+        PTE Table
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable






                                                   Virtual Address                                                                                       
                                                   64/32                                                                                            0    
                                                   +------------------+------------------+------------------+------------------+--------------------+    
                                                   |    PGD_OFFSET    |    PUD_OFFSET    |    PMD_OFFSET    |    PTE_OFFSET    |     PAGE_OFFSET    |    
                                                   +------------------+------------------+------------------+------------------+--------------------+    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |                    
                                                       |                      |                      |    +-------------+ 
                                                       |                      |                      |    | ........... | 
                                                       |                      |                      |    +-------------+ 
                                                       |                      |    +-------------+   o--->|             |
                                                       |                      |    | ........... |        +-------------+ 
                                                       |                      |    +-------------+        | ........... |
                                                       |    +-------------+   o--->|             |------->+-------------+
                                                       |    | ........... |        +-------------+         PUDTable
                                                       |    +-------------+        | ........... |
                                                       o--->|             |------->+-------------+
                                                            +-------------+        PMDTable
                                                            | ........... |
                                                            +-------------+
                                                            PGTable







                                                Virtual Linuear Space

                                                BISCUITOS_PAGE_OFFSET
                                                0x90000000
                                                | <---------------------------- BISCUITOS_LINEAR_SIZE ------------------------------> |
                                                +-------------------------------------------------------------------------------------+
                                                |                                                                                     |
                                                |                                                                                     |
                                                |                                                                                     |
                                                +-------------------------------------------------------------------------------------+
                                                A                                                                                     A
                                                | <---------------------------- Linear Mapping -------------------------------------> |
                                                V                                                                                     V
                                                +-------------------------------------------------------------------------------------+
                                                |                                                                                     |
                                                |                                                                                     |
                                                |                                                                                     |
                                                +-------------------------------------------------------------------------------------+
                                                0x70000000
                                                BISCUITOS_RAM_BASE
                                                BISCUITOS_LINEAR_BASE
                                                Physical Space

                                                Virtual_Addr = Physical_Addr + 0x20000000




                                                 Physical Memory Allocator: Initialize
                                                 
                                                 | <------------------------------- BISCUITOS_CROSS_SIZE_PHYS -------------------------------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 A
                                                 |
                                                 |
                                                 o-- BISCUITOS_CROSS_BASE_PHYS

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+




                                                 Virtual Memory Allocator: Initialize

                                                 | <------------------------------- BISCUITOS_CROSS_SIZE_VIRT -------------------------------------> |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 | Region0 | Region1 | Region2 | Region3 | Region4 | ....... | RegionM | RegionN | RegionT | RegionX |
                                                 |         |         |         |         |         |         |         |         |         |         |
                                                 +---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+
                                                 A
                                                 |
                                                 |
                                                 o-- BISCUITOS_CROSS_BASE_VIRT

                                                 Bitmap
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                                                 |0|0|0|0|0|0|0| ..... |0|0|0|0|0|0|
                                                 +-+-+-+-+-+-+-+-------+-+-+-+-+-+-+














                                                 Application/Shell/Shared Library
                                            ---  -----------------------------------------------------------
                                             A                     A                               A
                                             |                     |                               |
                                             |                     |                               |
                                Kernel Space |                     V                               |
                                             |   ----------------------------------------          | Kernel Module
                                             |      Memory Manager Unit Subsystem(Host)            |
                                             V   ----------------------------------------          |
                                            ---  MEMBLOCK | Buddy | Slub | VMALLOC | ....          |
                                                                                                   |
                                                                                                   V
                                                                                          -------------------
                                                                                              MMU(Module)
                                                                                          -------------------
                                                                                            Memory Allocator




           struct list_head
           +-------------+          +------------+          +------------+          +------------+
           | cache_chain | <------> | kmem_cache | <------> | kmem_cache | <------> | kmem_cache |
           +-------------+          +------------+          +------------+          +------------+







           struct kmem_cache                                                                                             
           +------------------+                                                                                                                                  struct array_cache
           | array[0]         |--------------------------------------------------------------------------------------------------------------------------------->+-----------------+
           +------------------+                                                                                                                                  | avail           |
           | array[1]         |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | limit           |
           | ........         |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | batchcount      |
           | array[NR_CPUS-1] |                                                                                                                                  +-----------------+
           +------------------+                                                                                                                                  | touched         |
           | batchcount       |                                                                                                                              --- +-----------------+
           +------------------+                                                                                                                               A  | entry[0]        |------o
           | limit            |                                                                                                                               |  +-----------------+      |
           +------------------+                                                                                                                    batchcount |  | ........        |      |
           | shared           |                                                                                                                               |  +-----------------+      |
           +------------------+                                                                                                                               V  | entry[N]        |----o |
           | buffer_size      |                                                                                                                              --- +-----------------+    | |
           +------------------+                                                                                                                                                         | |
           | gfporder         |                                                               | <--------------------------- PAGE_SIZE --------------------------> |                    | |
           +------------------+                                                               +-+-------------+-------------------+--------+--------+-----+--------+                    | |
           | gfpflags         |                                                               | |             |                   |        |        |     |        |                    | |
           +------------------+                                                               | | struct slab | kmem_bufctl array | object | object | ... | object |                    | |
           | colour           |                                                               | |             |                   |        |        |     |        |                    | |
           +------------------+                                                               +-+-------------+-------------------+--------+--------+-----+--------+                    | |
           | colour_off       |                                                                    A                                           A              A                         | |
           +------------------+                                                                    |                                           |              |                         | |
           | slabp_cache      |                                                                    |                                           |              o-------------------------o |
           +------------------+                                                        o-----------o                                           o------------------------------------------o
           | slab_size        |                                                        |                                                       
           +------------------+                                                        |      | <--------------------------- PAGE_SIZE --------------------------> | 
           | name             |                                                        |      +-+-------------+-------------------+--------+--------+-----+--------+
           +------------------+                                                        |      | |             |                   |        |        |     |        |
           | next             |                                                        |      | | struct slab | kmem_bufctl array | object | object | ... | object |
           +------------------+              struct kmem_list3                         |      | |             |                   |        |        |     |        |
           | nodelists[0]     |------------->+-----------------+                       |      +-+-------------+-------------------+--------+--------+-----+--------+
           +------------------+              | slabs_partial   |<----------------------o           A
           | nodelists[1]     |              +-----------------+                                   |
           +------------------+              | slabs_full      |<----------------------------------o
           | ............     |              +-----------------+                               
           +------------------+              | slabs_free      |<----------------------------------o                  
           | nodelists[M-1]   |              +-----------------+                                   |
           +------------------+              | free_object     |                                   V    
                                             +-----------------+                              +-+-------------+-------------------+--------+--------+-----+--------+     
                                             | colour_next     |                              | |             |                   |        |        |     |        |   
                                             +-----------------+                              | | struct slab | kmem_bufctl array | object | object | ... | object |
                                                                                              | |             |                   |        |        |     |        |
                                                                                              +-+-------------+-------------------+--------+--------+-----+--------+
                                                                                              | <--------------------------- PAGE_SIZE --------------------------> |
                                                                                              









                                                                                
                                                     o------------- list        
                                                     | o----------- colouroff   
                                                     | | o--------- s_mem --------------o      
                                                     | | | o------- inuse               |
                                                     | | | | o----- free                |
                                                     | | | | | o--- nodeid              |
                                                     | | | | | |                        |
                                                     V V V V V V    colouroff           V
                                           | <----------------------------------------> |
                                           +--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                           |        | | | | | | | | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           | COLOUR | | | | | | | | | | | | | | | | | | | Object | Object | Object | Object | Object | ..... | Object | Object | Left_Over |
                                           |        | | | | | | | | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           +--------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                                    | <-------> | <-------------------> |                
                                                    struct slab     kmem_bufctl array
                                                         


                                                         
                                                   
                                                   
                                                   
                                                   
                                                   
                                                   
                                                   
                                                                     kmem_bufctl array
                                                                  | <-----------------> |
                                           +--------+-------------+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                           |        |             | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           | COLOUR | struct slab |1|2|3|4|5|.|.|.|.|N| | Object | Object | Object | Object | Object | ..... | Object | Object | Left_Over |
                                           |        |             | | | | | | | | | | | |        |        |        |        |        |       |        |        |           |
                                           +--------+-------------+-+-+-+-+-+-+-+-+-+-+-+--------+--------+--------+--------+--------+-------+--------+--------+-----------+
                                                                                       A
                                                                                       |
                                                                                       o--- BUFCTL_END









                                            o------------- list
                                            | o----------- colouroff
                                            | | o--------- s_mem 
                                            | | | o------- inuse  
                                            | | | | o----- free   
                                            | | | | | o--- nodeid 
                                            | | | | | |           
                                            V V V V V V           
                                            struct slab    kmem_bufctl array
                                           | <-------> | <-------------------> |
                                           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                           | | | | | | | | | | | | | | | | | | |
                                           | | | | | | |1|2|3|4|5|6|7|8|9|.|N| |
                                           | | | | | | | | | | | | | | | | | | |
                                           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                |                             A
                                                |                             |
                                                o---o                         o--- BUFCTL_END
                                                    | s_mem
                                                    V
                                           +--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+-----------+
                                           |        |        |        |        |        |        |        |        |        |        |        |        |        |           |
                                           | COLOUR | Object | Object | Object | Object | Object | Object | Object | Object | Object | ...... | Object | Object | Left_Over |
                                           |        |        |        |        |        |        |        |        |        |        |        |        |        |           |
                                           +--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+-----------+












           struct kmem_cache
           +------------------+                                                                                                     struct array_cache
           | array[0]         |---------------------------------------------------------------------------------------------------->+-----------------+
           +------------------+                                                               struct array_cache                    | avail           |
           | array[1]         |---------------------------------------------------------------+-----------------+                   +-----------------+
           +------------------+                                                               | avail           |                   | limit           |
           | ........         |                                                               +-----------------+                   +-----------------+
           +------------------+                        struct array_cache                     | limit           |                   | batchcount      |
           | array[NR_CPUS-1] |----------------------->+-----------------+                    +-----------------+                   +-----------------+
           +------------------+                        | avail           |                    | batchcount      |                   | touched         |
           | batchcount       |                        +-----------------+                    +-----------------+               --- +-----------------+
           +------------------+                        | limit           |                    | touched         |                A  | entry[0]        |
           | limit            |                        +-----------------+                --- +-----------------+                |  +-----------------+
           +------------------+                        | batchcount      |                 A  | entry[0]        |     batchcount |  | ........        |
           | shared           |                        +-----------------+                 |  +-----------------+                |  +-----------------+
           +------------------+                        | touched         |      batchcount |  | ........        |                V  | entry[N]        |
           | buffer_size      |                    --- +-----------------+                 |  +-----------------+               --- +-----------------+
           +------------------+                     A  | entry[0]        |                 V  | entry[N]        |                                                       
                                                    |  +-----------------+                --- +-----------------+
                                         batchcount |  | ........        |
                                                    |  +-----------------+
                                                    V  | entry[N]        |
                                                   --- +-----------------+







                      start_kernel
                         |
                         o--- mm_init
                         |       |
                         |       o--- kmem_cache_init
                         |
                         o--- kmem_cache_init_late



                                                 ---------------------------------------------------------
                                                                  struct kmem_cache
                                                 ---------------------------------------------------------
                                                                     Local Cache
                                                 ---------------------------------------------------------
                                                                    Shared Cache
                                                 ---------------------------------------------------------
                                                                 


                                         +------------+       +-------------+       +--------------+       +-----------+       +-------+
                                         | kmem_cache | <---> | Local Cache | <---> | Shared Cache | <---> | Slab list | <---> | Buddy |
                                         +------------+       +-------------+       +--------------+       +-----------+       +-------+







                       struct page
                       +-------+--------+-----------+---------+---------+-------------------+               
                       | flags | _count | _mapcount | private | mapping | ....              |
                       +-------+--------+-------+---+----+----+-+------++-------------------+
                       | flags | _count | units | pad[2] | free | list | ....               |
                       +-------+--------+-------+--------+------+------+--------------------+
                       struct slob_page                      |
                                                             |
                                                             |
                                      o----------------------o
                                      |
                                      |
                                      V                      
                       | <------------------------------------- PAGE_SIZE --------------------------------------> |
                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+----------+-+-+-+-+-+-+
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |          | | | | | | |
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | ........ | | | | | | |
                       | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |          | | | | | | |
                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+----------+-+-+-+-+-+-+
                                      A A A <-------------------------- slob offset ----------------------------> |
                                      | | |
                                      | | o--- slob units
                                      | o----- slob offset
                                      o------- slob size



                        
                        Physical Memory
 
                        |<-16M->| <--------- 64M ---------> |      | <-- Reserved -> | <-- RAM --> | <- ACPI Reserved -> |     
                        +-------+---------------------------+------+-----------------+-------------+---------------------+
                        |       |                           |      |                 |             |                     |
                        |       |                           | ...  |                 |             |                     |
                        |       |                           |      |                 |             |                     |
                        +-------+---------------------------+------+-----------------+-------------+---------------------+
                        A       A                                  A                 A             A
                        |       |                                  |                 |             |
                        | o-----o                                  |                 |             |
                        | |       o--------------------------------o                 |             |
                        | |       | o------------------------------------------------o             |
                        | |       | | o------------------------------------------------------------o
                        | |       | | |
                        | |       | | |
                        | |       | | | 
                       +-+-+-----+-+-+-+-+-+-+-+-+-+
                       | | |     | | | | | | | | | |
                       | | | ... | | | | | | | | | |
                       | | |     | | | | | | | | | |
                       +-+-+-----+-+-+-+-+-+-+-+-+-+
                       e820_table







                                        | <- Exist Area -> |
                         +--------+-----+------------------+--------+-----------------------+
                         |        |     |                  |        |                       |
                         |        |     |                  |        |                       |
                         |        |     |                  |        |                       |
                         +--------+-----+------------------+--------+-----------------------+
                                  | <-------- Remove Area --------> |

                                                 |
                                                 V

                         +--------+---------------------------------+-----------------------+
                         |        |                                 |                       |
                         |        |                                 |                       |
                         |        |                                 |                       |
                         +--------+---------------------------------+-----------------------+
                                  | <-------- Remove Area --------> |




                                                   | <- Remove Area -> |
                         +--------------+----------+-------------------+-----------+---------------+
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         +--------------+----------+-------------------+-----------+---------------+
                                        | <------------- Exist Area -------------> |


                                                            |
                                                            V
                                                 
                         +--------------+----------+-------------------+-----------+---------------+
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         |              |          |                   |           |               |
                         +--------------+----------+-------------------+-----------+---------------+
                                        | <- NA0-> |                   | <- NA1 -> |



                                        | <- Region -> |
                         +--------+-----+--------------+-------------+-----------------------+
                         |        |     |              |             |                       |
                         |        |     |              |             |                       |
                         |        |     |              |             |                       |
                         +--------+-----+--------------+-------------+-----------------------+
                                  | <-------- Search Range --------> |



                                           | <- Search Range -> |  
                         +--------+--------+--------------------+----------+-----------------------+
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         +--------+--------+--------------------+----------+-----------------------+
                                  | <-------------- Region --------------> |

                                                      |
                                                      V
                                  |<- R0 ->| <--- Region1 ----> | <- R2 -> |
                         +--------+--------+--------------------+----------+-----------------------+
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         |        |        |                    |          |                       |
                         +--------+--------+--------------------+----------+-----------------------+


                                          | <------- Region -------> |
                         +--------+-------+---+----------------------+-----------------------+
                         |        |       |   |                      |                       |
                         |        |       |   |                      |                       |
                         |        |       |   |                      |                       |
                         +--------+-------+---+----------------------+-----------------------+
                                  | <- SRs -> |



                                  | <----------- Region -----------> |
                         +--------+-------------------+--------------+--------+--------------+
                         |        |                   |              |        |              |
                         |        |                   |              |        |              |
                         |        |                   |              |        |              |
                         +--------+-------------------+--------------+--------+--------------+
                                                      | <-- Search Region --> |








               

                       arch/x86/boot/main.c

                       main
                         |
                         o-> detect_memory
                               |
                               o-> detect_memory_e820
                               |
                               o-> detect_memory_e801
                               |
                               o-> detect_memory_88

                  





                         Case0:

                                  | <-------- Exist Region --------> |
                         +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:

                                  | <------------ Exist Region ------------> |
                         +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:

                                  | <------------ Exist Region ------------> |
                         +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |







                         Case0:
                                                                                                                                                                                  
                                  | <-------- Exist Region --------> |                                              | <-------------- New Region --------------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:
                                                                                                                                                                                 
                                  | <------------ Exist Region ------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:
                                                                                                                                                                                
                                  | <------------ Exist Region ------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |





                         Case0:
                                                                                                                                                        
                                  | <-------- Exist Region --------> |                                              | <-Split Region0-> | <---- New Region ----> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <---- New Region ----> |

                         Case1:
                                                                                               
                                  | <------------ Exist Region ------------> |                                      | <-Split Region0-> | <--- New Region ---> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <--- New Region ---> |

                         Case2:
                                                                                              
                                  | <------------ Exist Region ------------> |                                      | <-Split Region0-> | <-New Region0-> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      | <-New Region -> |                                                                                 |<-->|
                                                                                                                                                        Insert Region










                         Case0:

                                  | <--------- New Region ---------> |
                         +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |

                         Case1:

                                  | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+
                                                      | <-- Exist Region --> |

                         Case2:

                                  | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+
                                                      |<-Exist Region ->|



                         Case1:

                                  | <------------- New Region -------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                         |        |                   |                      |               |             |        |                   |                      |               |
                         |        |                   |                      |               |   ----->    |        |                   |                      |               |
                         |        |                   |                      |               |             |        |                   |                      |               |
                         +--------+-------------------+----------------------+---------------+             +--------+-------------------+----------------------+---------------+
                                                      | <-- Exist Region --> |

                         Case2:

                                  | <------------- New Region -------------> |                                      | <------------- New Region -------------> |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         |        |                   |                 |    |               |   ----->    |        |                   |                 |    |               |
                         |        |                   |                 |    |               |             |        |                   |                 |    |               |
                         +--------+-------------------+-----------------+----+---------------+             +--------+-------------------+-----------------+----+---------------+
                                                      |<-Exist Region ->|



                         Case0:

                                  | <--------- New Region ---------> |                                              | <--------- New Region ---------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |                                                                       | <-----> |
                                                                                                                                                       Exist Region





                         Case0:

                                  | <--------- New Region ---------> |                                              | <-------------- New Region --------------> |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         |        |                   |              |         |             |   ----->    |        |                   |              |         |             |
                         |        |                   |              |         |             |             |        |                   |              |         |             |
                         +--------+-------------------+--------------+---------+-------------+             +--------+-------------------+--------------+---------+-------------+
                                                      | <--- Exist Region ---> |                                                                    
                                                                                                                                                    






































dfasdf




  handle_post
    |
    o-> do_post
          |
          o-> qemu_preinit
          |     |
          |     o-> e820_add(0, RamSize, E820_RAM)
          |     |   0x00000000-0x40000000
          |     |
          |     o-> e820_add(0xFFFC0000, 256KB, E820_RESERVED)
          |         0xfffc0000-0x100000000
          |
          o-> coreboot_preinit
          |     |
          |     o-> !CONFIG_COREBOOT
          |
          o-> malloc_preinit
          |     |
          |     o-> e820_remove(BUILD_LOWRAM_END, BUILD_BIOS_ADDR-BUILD_LOWRAM_END)
          |     |   0xa0000-0x100000
          |     |
          |     o-> e820_add(BUILD_BIOS_ADDR, BUILD_BIOS_SIZE, E820_RESERVED)
          |     |   0xf0000-0xfffff
          |     |
          |     o-> e820_add(highram, BUILD_MAX_HIGHTABLE, E820_RESERVED)
          |         0x3ffc0000-0x40000000
          |
          o-> maininit
                |
                o-> interface_init
                |     |
                |     o->qemu_cfg_init
                |          |
                |          o-> qemu_cfg_e820
                |                |
                |                o-> e820_add(table[i].address, table[i].length, table[i].type)
                |                |   0xfeffc000-0xff000000
                |                |
                |                o-> e820_add(entry.address, entry.length, entry.type)
                |                |
                |                o-> e820_add(0xfffbc000, 4*4096, E820_RESERVED)
                |                |   0xfffbc000-0xfffc0000  
                |                |
                |                o-> e820_add(0x100000000ull, high, E820_RAM)
                |                    0x100000000-
                |
                o-> prepareboot
                      |
                      o-> malloc_prepboot
                      |     |
                      |     o-> e820_add(endlow, BUILD_LOWRAM_END-endlow, E820_RESERVED)
                      |     |   0x9fc00-0xa0000
                      |     |
                      |     o-> e820_add(info->range_start, giveback, E820_RAM)
                      |     |   0x3ffc0000-0x3ffe0000
                      |     |
                      |     o-> calcRamSize
                      |
                      o-> e820_prepboot
                            |
                            o-> dump_map

      handle_15
        |
        o-> handle_15e8
              |
              o-> handle_15e801
              |
              o-> handle_15e820
              |
              o-> handle_15e8XX






  +-------+-----------+---------+---------------+------------+------------+-----------------------------------------------------+
  |       |           |         |               |            |            |                                                     |
  |       |           |         |               |            |            |                                                     |
  |       |           |         |               |            |            |                                                     |
  +-------+-----------+---------+---------------+------------+------------+-----------------------------------------------------+
  | <---> | <-------> | <-----> | <-----------> | <--------> | <--------> |
  A   A   A     A     A
  |   |   |     |     |
  |   |   |     |     |
  |   |   |     |     |
  |   |   |     |     o- 0X4FF
  |   |   |     o------- BDA 







                           "Real mode Address Space (< 1 MiB)"

                                                        ----- +---------------------------------+ --> 0x100000
                                                        A  A  |                                 |  A
                                                        |  |  |                                 |  | Metherboard BIOS
                                                        |  |  |                                 |  V
                                                        |  |  +---------------------------------+ --> 0xF0000
                      [ROM and hardware mapped/Shadow RAM] |  |                                 |  A
                                                        |  |  |                                 |  |
                                                        |  |  |                                 |  | BIOS Expansion
                                                        |  |  |                                 |  |
                              "384 KiB System/Reserved" |  |  |                                 |  V
                                      "Upper Memory"    |  |  +---------------------------------+ --> 0xC8000
                                                        |  |  |                                 |  A
                                                        |  |  |                                 |  | Video BIOS
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0xC0000
                                                        |  A  |                                 |  A
                                         [hardware mapped] |  |                                 |  | Video display memory
                                                        V  V  |                                 |  V
                                                        ----- +---------------------------------+ --> 0xA0000
                                                        A  A  |                                 |  A
                                  [partially used by EBDA] |  |                                 |  | EBDA (Extended BIOS Data Area)
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0x80000
                                                        |  A  |                                 |  A
                                                        |  |  |                                 |  | Conventional memory
                                                        |  |  |                                 |  V
                                                        |  |  +---------------------------------+ --> 0x07E00
                                          [usable memory]  |  |                                 |  A
                                                        |  |  |                                 |  |
                                                        |  |  |                                 |  |  OS BootSector
                                          "640 KiB RAM" |  |  |                                 |  |
                                          "Low Memory"  |  |  |                                 |  V  
                                                        |  |  +---------------------------------+ --> 0x07C00
                                                        |  |  |                                 |  A
                                                        |  |  |                                 |  | Conventional memory
                                                        |  V  |                                 |  V
                                                        |  -- +---------------------------------+ --> 0x00500
                                                        |  A  |                                 |  | BDA (BIOS Data Area)
                                                        |  |  +---------------------------------+ --> 0x00400
                                   [unusable in real mode] |  |                                 |  A
                                                        |  |  |                                 |  | Real Mode IVT (Interrupt Table)
                                                        V  V  |                                 |  V
                                                        ----- +---------------------------------+ --> 0x00000










Offset    Size         Description                                          Info
00h       1 byte       Size of Extended BIOS Data Area                      1 = 1024 bytes; 2 = 2048 bytes
17h       1 byte       Number of POST error entries 	 
18h       5 byte       POST error log
22h       1 dword      Mouse device driver far call                         pointer to the mouse device driver in 
                                                                            segment:offset format
26h       1 byte       Mouse flags 1
                       Bit 7    Command in progress; 0 = no, 1 = yes
                       Bit 6    Mouse sent a Resend byte (FAh)
                       Bit 5    Mouse sent an Acknowledge byte (FEh)
                       Bit 4    Mouse sent an error byte (FCh)
                       Bit 3    Unexpected value received
                       Bit 2-0  Index count; used to retrieve up to 8 
                                bytes from the controller; successive
                                bytes are stored starting at offset 28h
27h       1 byte       Mouse flags 2
                       Bit 7    Device driver far call flag
                       Bit 6-3  Not used, or function unknown
                       Bit 2-0  Package count; the number of bytes received
                                from the mouse
28h       8 bytes      Mouse data
39h       1 word       Watchdog timer                                       Initial count value of the watchdog 
                                                                            timer; 0 = watchdog timer not active
3Dh       16 bytes     Hard disk 0 parameter table                          The structure of this table is equal
                                                                            to the hard disk drive parameter table.
4Dh       16 bytes     Hard disk 1 parameter table                          The structure of this table is equal to
                                                                            the hard disk drive parameter table.
68h       1 byte       Cache control
                       Bit 7-2  Not used                                    Primarily used for CPUs with on-chip
                       Bit 1    Cache test:                                 cache: 486 CPUs and IBM 386SLC.
                                0 = test successful
                                1 = test failed
                       Bit 0    CPU cache enable:
                                0 = enabled
                                1 = disabled
6Eh       1 byte       Keyboard repeat rate                                 Values saved are identical to the values
                                                                            used by Int 16h, function 03h.
6Fh       1 byte       Delay until keys repeat                              Values saved are identical to the values
                                                                            used by Int 16h, function 03h.
70h       1 byte       Number of hard disk drives installed                 Number of drives as detected by POST: 
                                                                            0, 1 or 2
71h       1 byte       DMA channel for hard disk drive                      Default: channel 5
72h       1 byte       Hard disk interrupt status                           1Fh = timeout has occurred
73h       1 byte       Hard disk operation flags
                       Bit 7    1 = controller issued an operation 
                                    complete interrupt
                       Bit 6    1 = controller has been reset
                       Bit 5-0  Not used
74h       1 dword      Old Int 76h vector pointer
78h       1 byte       Hard disk DMA type                                   This byte is used as temporary storage
                                                                            for the DMA extended mode register.
79h       1 byte       Hard disk: status of last operation                  The value stored is the value returned
                                                                            by Int 13h, function 01h.
7Ah       1 byte       Hard disk: timeout value                             The timeout value is set by POST to
                                                                            indicate how long BIOS disk services
                                                                            should wait for the controller to indicate
                                                                            the operate has completed.
7E        8 words      hHard disk controller: return status words           ESDI - PS/2
E7h       1 byte       Diskette drive type
                       Bit 	
                       Bit 	
                       Bit 	
ECh       1 byte       Hard disk parameters loaded
                       Bit 	
                       Bit 	
EEh       1 byte       CPU family ID                                        The value stored is the value returned
                                                                            by Int 15h, function C9h
EFh       1 byte       CPU stepping                                         The value stored is the value returned
                                                                            by Int 15h, function C9h
117h      1 word       Keyboard ID
11Ah      1 word       Non-BIOS Int 18h flag
                       Bit 7-1  Not used
                       Bit 0    Set to 1 before calling user Int 18h.
11D       1 dword      User Int 18h far pointer




                   CMOS --o
                          |     +--------------+  Interrup Vector Table    +------------------+ 
                    BDA -(+)--> | seaBIOS/BIOS | ------------------------> | Kernel Real mode | 
                          |     +--------------+                           +------------------+ 
                   EBDA --o





         
                   CMOS --o
                          |     +--------------+  IVT    +------------------+  E820 map   +---------------------+  E820 Firmware   +-----------+
                    BDA -(+)--> | seaBIOS/BIOS | ------> | Kernel Real mode | ----------> | Kernel Protect mode | ---------------> | Userspace |
                          |     +--------------+         +------------------+             +---------------------+                  +-----------+
                   EBDA --o





                                                  BDA --o
                                                        |
                                      o---->   hw_cfg --o
                +---------------+     |                 |     +--------------+  Interrup Vector Table    +------------------+
                | qemu/qemu-kvm |----(+)--->    CMOS --(+)--> | seaBIOS/BIOS | ------------------------> | Kernel Real mode | 
                +---------------+     |                 |     +--------------+                           +------------------+
                                      o----> etc/e820 --o
                                                        |
                                                 EBDA --o




        kvm_init
          |
          o- kvm_arch_init
               |
               o- kvm_check_extension(s, KVM_CAP_SET_IDENTITY_MAP_ADDR)
               |  identity_base = 0xfeffc000
               |
               o- e820_add_entry(identity_base, 0x4000, E820_RESERVED)

        pc_init_v3_1
          |
          o- pc_init1
               |
               o-> pcms->above_4g_mem_size
               |
               o-> pcms->below_4g_mem_size
               |
               o-> pc_memory_init
               |    |
               |    o-> e820_add_entry(0, pcms->below_4g_mem_size, E820_RAM)
               |    |
               |    o-> e820_add_entry(0x100000000ULL, pcms->above_4g_mem_size, E820_RAM)
               |    |
               |    o-> bochs_bios_init
               |          |
               |          o->fw_cfg_add_bytes(fw_cfg, FW_CFG_E820_TABLE, &e820_reserve, sizeof(e820_reserve))
               |          |
               |          o-> fw_cfg_add_file(fw_cfg, "etc/e820", e820_table, sizeof(struct e820_entry) * e820_entries)
               |          
               o-> pc_cmos_init
                     |
                     o-> rtc_set_memory           





  Real_mode:

  main
    |
    o-> detect_memory
          |
          o-> detect_memory_e820
          |     |
          |     o-> boot_params.e820_table
          |     |
          |     o-> boot_params.e820_entries
          |        
          o-> detect_memory_e801
          |     |
          |     o-> boot_params.alt_mem_k
          |
          o-> detect_memory_88
                |
                o-> boot_params.screen_info.ext_mem_k

  Protect_Mode:

  start_kernel
    |
    o-> setup_arch
          |
          o-> e820__memory_setup
          |     |
          |     o-> e820__memory_setup_default
          |     |     |
          |     |     o-> append_e820_table(boot_params.e820_table, boot_params.e820_entries)
          |     |     |
          |     |     o-> e820__update_table(e820_table)
          |     |
          |     o-> e820_table_kexec/e820_table_firmware
          |     |
          |     o-> e820__print_table("BIOS-e820")
          |
          o-> parse_setup_data
          |     |
          |     o-> e820__memory_setup_extended
          |           |
          |           o-> e820__print_table("extended")
          |
          o-> parse_early_param
          |     |
          |     .. parse_memopt("mem")
          |     |    |
          |     |    o-> e820__range_remove
          |     |
          |     .. parse_memmap_opt("memmap")
          |          |
          |          o-> parse_memmap_one
          |
          o-> e820__reserve_setup_data
          |     |
          |     o-> e820__update_table(e820_table/e820_table_kexec)
          |     |
          |     o-> e820__print_table("reserve setup_data")
          |
          o-> e820__finish_early_params
          |     |
          |     o-> e820__print_table("user")
          |
          o-> e820_add_kernel_range
          |     |
          |     o-> e820__mapped_all
          |           |
          |           o-> __e820__mapped_all
          |
          o-> e820__end_of_ram_pfn -> "max_pfn"/"max_low_pfn"
          |     |
          |     o-> e820_end_pfn
          |
          o-> e820__memblock_setup
          |
          o-> e820__memblock_alloc_reserved_map_new
          |
          o-> e820__reserve_resources
          |     |
          |     o-> firmware_map_add_early
          |
          o-> e820__setup_pci_gap
                |
                o-> e820_search_gap




             Physical Memory
             0
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             |                                    | | | | | | | | | | ..... | | | | | | | | |         |                  |
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
                                                  A         A                               A         A
             struct bootmem_data                  |         |                               |         |
             +----------------+                   |         o-- goal                        |         o-- limit
             |   node_min_pfn |-------------------o                                         |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+ 
             |   *bootmem_map |-----------o
             +----------------+           |       bitmap
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                                         A                         A
                                                         |                         |                          
                                                        sidx                      midx




             Physical Memory
             0
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             |                                    | | | | | | | | | | ..... | | | | | | | | |         |                  |
             |                                    | | | | | | | | | |       | | | | | | | | |         |                  |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------+------------------+
                                                  A         A                               A         A
             struct bootmem_data                  |         |                               |         |
             +----------------+                   |         o-- goal                        |         o-- limit
             |   node_min_pfn |-------------------o                                         |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+
             |   *bootmem_map |-----------o
             +----------------+           |       bitmap
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                                         A                   A     A
                                                         | <---------------> |     |
                                                        sidx    "range"     eidx  midx



             Physical Memory
             0  
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------------------------+
             |                                    | | | | | | | | | |       | | | | | | | | |                           |
             |                                    | | | | | | | | | | ..... | | | | | | | | |                           |
             |                                    | | | | | | | | | |       | | | | | | | | |                           |
             +------------------------------------+-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+-+-+---------------------------+
                                                  A         A                               A         
             struct bootmem_data                  |         |                               |         
             +----------------+                   |         |                               |         
             |   node_min_pfn |-------------------o         |                               |
             +----------------+                             |                               |
             |   last_end_off |-----------------------------o                               |
             +----------------+                                                             |
             |   node_low_pfn |-------------------------------------------------------------o
             +----------------+
             |       hint_idx |-----------------------------o
             +----------------+                             |
             |   *bootmem_map |-----------o                 |
             +----------------+           |       bitmap    V
                                          |       +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+
                                          o-----> | | | | | | | | ... | | | | | | | |
                                                  +-+-+-+-+-+-+-+-----+-+-+-+-+-+-+-+









               ARM Architecture

               start_kernel
                 |    
                 o-> setup_arch
                 |    |
                 |    o-> parse_tags
                 |    |     .
                 |    |     o-> parse_tag_mem32
                 |    |           |
                 |    |           o-> arm_add_memory
                 |    |
                 |    o-> paging_init
                 |          |
                 |          o-> sort(meminfo)
                 |          |
                 |          o-> sanity_check_meminfo
                 |          |
                 |          o-> bootmem_init
                 |                |
                 |                o-> bootmem_init_node
                 |                |     |
                 |                |     o-> bootmem_bootmap_pages
                 |                |     |
                 |                |     o-> find_bootmap_pfn
                 |                |     |
                 |                |     o-> init_bootmem_node
                 |                |     
                 |                o-> bootmem_free_node
                 |                |     |
                 |                |     o-> free_area_init_node
                 |                |           |
                 |                |           o-> alloc_node_mem_map
                 |                |           |
                 |                |           o-> free_area_init_core
                 |                |
                 |                o-> high_memory/max_low_pfn/max_pfn
                 |
                 o-> mm_init
                       |
                       o-> mem_init
                             |
                             o-> free_all_bootmem_node
                                   |
                                   o-> free_all_bootmem_core
                                         |
                                         o-> __free_pages_bootmem
                                               |
                                               o-> __free_page/__free_pages 
             
             


                Physical Memory

                +----------------------------------------+----------------+----------------------------------------+
                |                                        |                |                                        |
                |                                        |                |                                        |
                |                                        |                |                                        |
                +----------------------------------------+----------------+----------------------------------------+
                | <--------- Available Memory ---------> | <--- Hole ---> | <--------- Available Memory ---------> |
                A                                        A                A                                        A
                |                                        |                |                                        |
                |                                        |                |                                        |
                o- 0x00000000                            o- 0x06000000    o- 0x08000000                0x0E000000 -o









                i386 Architecture

                start_kernel
                  |
                  o-> setup_arch
                  |     |
                  |     o-> initmem_init
                  |     |     |
                  |     |     o-> setup_bootmem_allocator
                  |     |           |
                  |     |           o-> bootmem_bootmap_pages
                  |     |           |
                  |     |           o-> setup_node_bootmem
                  |     |           |     |
                  |     |           |     o-> init_bootmem_node
                  |     |           |     |     |
                  |     |           |     |     o-> init_bootmem_core
                  |     |           |     |
                  |     |           |     o-> free_bootmem_with_active_region
                  |     |           |           |
                  |     |           |           o-> free_bootmem_node
                  |     |           |
                  |     |           o-> after_bootmem = 1
                  |     |
                  |     o-> dma32_reserve_bootmem
                  |
                  o-> mm_init
                        |
                        o-> mem_init
                              |
                              o-> free_all_bootmem
                                    |
                                    o-> free_all_bootmem_core





                X64 Architecture

                start_kernel
                  |
                  o-> setup_arch
                  |     |
                  |     o-> initmem_init
                  |     |     |
                  |     |     o-> bootmem_bootmap_pages
                  |     |     |
                  |     |     o-> init_bootmem_node
                  |     |     |
                  |     |     o-> free_bootmem_with_active_regions
                  |     |           |
                  |     |           o-> free_bootmem_node
                  |     |
                  |     o-> dma32_reserve_bootmem
                  |
                  o-> mm_init
                        |
                        o-> mem_init
                              |
                              o-> free_all_bootmem
                                    |
                                    o-> free_all_bootmem_core





                 Physical Memory
                 0                                                   
                 +----------------------------------+----------+----------------+-----+
                 |                                  |          |                |     |
                 |                                  |          |                |     |
                 |                                  |          |                |     |
                 +----------------------------------+----------+----------------+-----+
                                                    A          A                A
                                                    |          |                |
                                                    |          |                |
                        __brk_base/_brk_start ------o          |                |
                                     _brk_end -----------------o                |
                                  __brk_limit ----------------------------------o




            Load Kernel Image
            -----------------
            _brk_end   = __brk_base
            _brk_start = __brk_base
            RESERVE_BRK(early_pgt_alloc, INIT_PGT_BUF_SIZE)
            RESERVE_BRK(dmi_alloc, 65536)

            start_kernel
              |
              o-> setup_arch
                    |
                    o-> reserve_brk
             



          


        .bss/.data --> RESERVE_BRK --> Early_res --> Bootmem/MEMBLOCK --> Buddy




                                                        ---
          Application                                    A
          ---------------------------------------------  | 
          Virtual Address Space (GVA)                    |
          ---------------------------------------------  |
                                                         | 
          Guest OS                                       | 
                                                         | VMX Non-Root
          ---------------------------------------------  |
          Physical Address Space (GPA)                   |
          ---------------------------------------------  |
                                                         |
          +------+   +------+      +------+   +------+   |
          | VCPU |   | VCPU | .... | VCPU |   | VCPU |   | 
          +------+   +------+      +------+   +------+   V
                                                        ---



                                                                         ---
          Application                                                     A
          --------------------------------------------------------------  |
          Virtual Address Space (GVA)                                     |
          --------------------------------------------------------------  |
                                                                          |
          Guest OS                                                        | VMX Non-Root
                                                                          | 
          --------------------------------------------------------------  |
          Physical Address Space (GPA)                                    V
          ============================================================== ---
          Virtual Address Space (HVA)                                     A
          --------------------------------------------------------------  |
                                                                          |
          Host OS                                                         | VMX Root
                                                                          |
          --------------------------------------------------------------  |
          Physical Address Space (HPA)                                    V
          -------------------------------------------------------------- ---








          +-----------------+   +-----------------+  +-----------------+ ---
          | Virtual-Machine |   | Virtual-Machine |  | Virtual-Machine |  A
          +-----------------+   +-----------------+  +-----------------+  |
          |    qemu-kvm     |   |    qemu-kvm     |  |    qemu-kvm     |  |
          +-----------------+   +-----------------+  +-----------------+  | Userspace
                                                                          |
          ==============================================================  |
          Virtual Address Space (HVA)                                     V
          -------------------------------------------------------------- ---
                                                                          A
          Host OS                                                         | Kernel
                                                                          V
          -------------------------------------------------------------- ---
          Physical Address Space (HPA)                                   
          -------------------------------------------------------------- 




          -------------------------------------------------------------- 
          Virtual Address Space (HVA)                                     
          -------------------------------------------------------------- 
                                                                         
          Host OS                                                       
                                                                         
          -------------------------------------------------------------- 
          Physical Address Space (HPA)
          -------------------------------------------------------------- 



                                    Virtual Address
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|   Physical   | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+        Physical Address
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|   Physical   | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|   Physcial   | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|   Physcial   | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                CR3              +--------------+
                                +----------+     |              |
                                | Physical | --> +--------------+
                                +----------+

             
             
            



                                    Guest OS

                                    GVA 
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+
                                              |                      |                      |                      |  +--------------+     o->|              |
                                              |                      |                      |                      |  |              |        +--------------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|     GPA      | -----> +--------------+
                                              |                      |                      |  |              |       +--------------+        Guest Physiacl Address
                                              |                      |                      |  +--------------+       |              |
                                              |                      |  +--------------+    o->|     GPA      | ----> +--------------+
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |                      |  |              |       +--------------+
                                              |                      |  +--------------+       |              |
                                              |  +--------------+    o->|     GPA      | ----> +--------------+
                                              |  |              |       +--------------+
                                              |  +--------------+       |              |
                                              o->|     GPA      | ----> +--------------+
                                                 +--------------+
                                                 |              |
                                gCR3             +--------------+
                                +----------+     |              |
                                |   GPA    | --> +--------------+
                                +----------+






                                    Guest OS

                                    GVA
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                    |      PGD_OFFSET      |      PUD_OFFSET      |      PMD_OFFSET      |      PTE_OFFSET      |      PAGE_OFFSET      |
                                    +----------------------+----------------------+----------------------+----------------------+-----------------------+
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |
                                              |                      |                      |                      |                       |  +--------------+
                                              |                      |                      |                      |  +--------------+     |  |              |
                                              |                      |                      |                      |  |              |     |  +--------------+  EPT   +-----------+
                                              |                      |                      |                      |  +--------------+     o->|     GPA      |------->|    HPA    | 
                                              |                      |                      |                      |  |              |        +--------------+  Walk  +-----------+
                                              |                      |                      |                      |  +--------------+        |              |
                                              |                      |                      |  +--------------+    o->|     GPA      |-o  o-->+--------------+
                                              |                      |                      |  |              |       +--------------+ |  |    
                                              |                      |                      |  +--------------+       |              | |  |
                                              |                      |  +--------------+    o->|     GPA      |-o  o->+--------------+ |  |
                                              |                      |  |              |       +--------------+ |  |                   |  |
                                              |                      |  +--------------+       |              | |  |                   V  |
                                              |                      |  |              |       +--------------+ |  |EPT            +---------+
                                              |                      |  +--------------+       |              | |  |Walk           |   HPA   |
                                              |  +--------------+    o->|     GPA      |-o  o->+--------------+ |  |               +---------+
                                              |  |              |       +--------------+ |  |                   |  |
                                              |  +--------------+       |              | |  |                   V  |
                                              o->|     GPA      |-o  o->+--------------+ |  |EPT            +---------+
                                                 +--------------+ |  |                   |  |Walk           |   HPA   |
                                                 |              | |  |                   V  |               +---------+
                                gCR3             +--------------+ |  |               +---------+
                                +----------+     |              | |  |EPT            |   HPA   |
                                |   GPA    |  o->+--------------+ |  |Walk           +---------+
                                +----------+  |                   |  |
                                     |Walk    |                   V  |
                                     V        |               +---------+
                                +----------+  |               |   HPA   |
                                |   HPA    |--o               +---------+
                                +----------+

             
















                                  
                               GPA
                               +-----------------------+----------------------+----------------------+----------------------+-----------------------+
                               |      PML4_OFFSET      |      PDP_OFFSET      |       PD_OFFSET      |       PT_OFFSET      |      PAGE_OFFSET      | 
                               +-----------------------+----------------------+----------------------+----------------------+-----------------------+
                                          |                      |                      |                      |                       |
                                          |                      |                      |                      |                       |
                                          |                      |                      |                      |                       |  +--------------+
                                          |                      |                      |                      |  +--------------+     |  |              |
                                          |                      |                      |                      |  |              |     |  +--------------+
                                          |                      |                      |                      |  +--------------+     o->|              |
                                          |                      |                      |                      |  |              |        +--------------+
                                          |                      |                      |                      |  +--------------+        |              |
                                          |                      |                      |  +--------------+    o->|     HPA      | -----> +--------------+
                                          |                      |                      |  |              |       +--------------+        Host Physical Memory
                                          |                      |                      |  +--------------+       |              |
                                          |                      |                      |  |              |       +--------------+
                                          |                      |                      |  +--------------+       |              |
                                          |                      |  +--------------+    o->|     HPA      | ----> +--------------+
                                          |                      |  |              |       +--------------+
                                          |                      |  +--------------+       |              |
                                          |  +--------------+    o->|     HPA      | ----> +--------------+
                                          |  |              |       +--------------+
                                          |  +--------------+       |              |
                                          |  |              |       +--------------+
                                          |  +--------------+       |              |
                                          o->|     HPA      | ----> +--------------+
                           EPTP              +--------------+
                           +-----------+     |              |
                           |    HPA    | --> +--------------+
                           +-----------+
     










                                +--------+  +--------+  +------------------------------------+
                                |  VMID  |  |  ASID  |  |               GVA                  |
                                +--------+  +--------+  +------------------------------------+
                                    |           | 
                                    |           |       +----------------------+-------------+
                                    |           |       |         GVPN         |    Offset   | -----------------------------------------------------o
                                    |           |       +----------------------+-------------+                                                      |
                                    |           |                                                                                                   |
                                    |           |       +-----+----------------+                                                                    |
                                    |           |       | tag |      index     |                                                                    |
                                    |           |       +-----+----------------+                                                                    |
                                    |           |          |                                                                                        |
                                    |           |          |              TLB                                                                       |
                                    |           |          |              +--------------+--------------+---------+----------+                      |
                                    |           |          |              | TLB VMID tag | TLB ASID tag | TLB tag | TLB data |                      |
                                    |           |          |              +--------------+--------------+---------+----------+                      |
                                    |           |          |                     |              |            |         |                            |
                                    |           |          |                     |              |            V         |                            |
                                    |           |          |                     |              |       +----------+   |                            |
                                    |           |          o---------------------+--------------+-----> | Miss/Hit |   |                            |
                                    |           |                                |              |       +----------+   |                            |
                                    |           |                                |              V                      |                            |
                                    |           |                                |         +----------+                V                            V
                                    |           o--------------------------------+-------> | Miss/Hit |                +----------------------+-------------+
                                    |                                            |         +----------+                |         HPPN         |    offset   |
                                    |                                            V                                     +----------------------+-------------+
                                    |                                       +----------+      
                                    o-------------------------------------> | Miss/Hit |                               +------------------------------------+
                                                                            +----------+                               |                HPA                 |
                                                                                                                       +------------------------------------+




                                                Guest OS                                             ---
                                                Physical memory region                                A
                                                +------------------------------------------+          |
                                                |                                          |          | Non-Root
                                                +------------------------------------------+          |
                                                                                                      V
                        ---------------------------------------------------------------------------- ---
                                                QEMU                                                  A
                                                struct kvm_userspace_memory_region                    |
                                                +------------------------------------------+          | Userspace
                                                |                                          |          |
                                                +------------------------------------------+          |
                                                                                                      V
                        ============================================================================ ===               
                                                                                                      A
                                                KVM                                                   |
                                                struct kvm_memory_slot                                |
                                                +------------------------------------------+          | Kernel
                                                |                                          |          |
                                                +------------------------------------------+          |
                                                                                                      V
                                                                                                     ---
                                                Physcial Memory                                       A
                                                +------------------------------------------+          | Hardware
                                                |                                          |          V
                                                +------------------------------------------+         ---





                                            QEMU
                                            struct kvm_userspace_memory_region
                                            +------------------+
                                            |             slot |
                                            +------------------+                                 +------------------------+
                                            |            flags |                         o-----> | Anonymous 4KiB Mmaping |
                                            +------------------+                         |       +------------------------+
                                            |  guest_phys_addr |                         |
                                            +------------------+                         |
                                            |      memory_size |                         |
                                            +------------------+                         |       +-----------------------------+
                                            |   userspace_addr | -----------------------(+)----> | Hugetlbfs/ HugePage mmaping |
                                            +------------------+                         |       +-----------------------------+
                                                                                         |
                                                                                         |
                                                                                         |
                                                                                         |       +---------------------+
                                                                                         o-----> | Private Memory Mmap |
                                                                                                 +---------------------+








                         struct kvm
                         +---------------+
                         |               |
                         +---------------+          struct kvm_memslots
                         |      memslots | -------> +------------------+
                         +---------------+          |                  |
                                                    +------------------+
                                                    |    id_to_index[] |
                                                    +------------------+
                                                    |       used_slots |
                                                    +------------------+
                                                    |      memslots[0] |
                                                    +------------------+            struct kvm_memory_slot
                                                    |      memslots[1] | ---------> +-----------------+
                                                    +------------------+            |        base_gfn |
                                                    |      .......     |            +-----------------+
                                                    +------------------+            |          npages |
                                                    |      memslots[M] |            +-----------------+
                                                    +------------------+            |  userspace_addr |
                                                    |      memslots[N] |            +-----------------+
                                                    +------------------+            |           flags |
                                                                                    +-----------------+
                                                                                    |              id |
                                                                                    +-----------------+
                                                                                    |            arch | 
                                                                                    +-----------------+








                                          Guest Physcial Memory
 
                                                                  Memory Space                                   IO Space              PCI Space
                                          | <----------------------------------------------------------> | <------------------> | <------------------> |
                                          +--------------------------------------------------------------+----------------------+----------------------+
                                          |                                                              |                      |                      |
                                          |                                                              |                      |                      |
                                          |                                                              |                      |                      |
                                          +--------------------------------------------------------------+----------------------+----------------------+
                          

                


                                                                                  Guest Physical Memory
                                     AddressSpace                
                                     +----------------+                           GPA:0    GPA:addr0                      GPA:addr1                      GPA:addr2                             GPA:MAX
                                     |                |                           |        |                              |                              |                                     |
                                     +----------------+                           +--------+------------------------------+---------------------+--------+-------------------------+-----------+
                                     |                |                           |        |                              |                     |        |                         |           |
                                     +----------------+                           |        |              R0              |          R1         |        |          R2             |           |
                                o----|           root |                           |        |                              |                     |        |                         |           |
                                |    +----------------+                           +--------+------------------------------+---------------------+--------+-------------------------+-----------+
                                |    |                |                                    A <---------- size0 ---------> A <----- size1 -----> |        A <------- size2 -------> |
                                |    +----------------+                                    |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |                                                          |                              |                              |
                                |    MemoryRegion(Root)             MemoryRegion (R0)      |       MemoryRegion (R1)      |       MemoryRegion (R2)      |
                                |    +-----------------+            +-----------------+    |       +-----------------+    |       +-----------------+    |
                                |    |                 |            |                 |    |       |                 |    |       |                 |    |
                                |    +-----------------+            +-----------------+    |       +-----------------+    |       +-----------------+    |
                                |    |                 |            |            addr |----o       |            addr |----o       |            addr |----o
                                |    +-----------------+            +-----------------+            +-----------------+            +-----------------+
                                |    |      subregions | <--------> | subregions_link | <--------> | subregions_link | <--------> | subregions_link |
                                |    +-----------------+            +-----------------+            +-----------------+            +-----------------+
                                |    |                 |            |       container |----o       |       container |----o       |       container |----o
                                o--> +-----------------+ <----o     +-----------------+    |       +-----------------+    |       +-----------------+    |
                                                              |                            |                              |                              |
                                                              |                            |                              |                              |
                                                              o----------------------------o------------------------------o------------------------------o




                                                                                                                                 Guest Physcial Memory
                                                                                                                                 GPA:0                   GPA:addr3                                         GPA:MAX
                                                                                                                                 |                       |                                                 |
                                                                                                                                 +-----------------------+-------------------------------------------------+
                                                                                                                                 |                       |                                                 |
                                                                                                                                 |                       |                                                 |
                                                                                                                                 +-----------------------+-------------------------------------------------+
                                                                                                                                                         A
                                                                                                                                                         |
                                                                                                                                                         |
                                                                                                                         o-------------------------------o
                                                                                                                         |
                                                                                                                         |       QEMU Virtual Space
                                                                                                                         |       HVA:addr0                      HAV:addr1                                  HAV:addr2
                                                                                                  RAMBlock (RB0)         |       |                              |                                          |
                                                                                                  +-----------------+    |       +------------------------------+------------------------------------------+
                                                                                                  |          offset |----o       |                              |                                          |
                                                                                                  +-----------------+            |                              |                                          |
                                                                                                  |            host |----------> +------------------------------+------------------------------------------+
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+            A <--------- size0 ----------> A <--------------- size1 ----------------> |
                                    +----------------+              +-----------------+           |            size |            |                              |
                                    |                |              |                 |           +-----------------+            |                              |
                                    +----------------+              +-----------------+           |                 |            |                              |
                                    |                |              |       ram_block | --------> +-----------------+            |                              |
                                    +----------------+              +-----------------+                                          |                              |
                               o----|           root |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+                                          |                              |
                               |    |                |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+ <--o------------------------------o      |                              |
                               |                                                           |                              |      |                              |
                               |                                                           |                              |      |                              |
                               |                                                           |   o-------------------------(+)-----o                              |
                               |                                                           |   |                          |                                     |
                               |                                                           |   |                          |                                     |
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |   |   MemoryRegion (R1)      |                                     |
                               |     +-----------------+            +-----------------+    |   |   +-----------------+    |                                     |
                               |     |                 |            |           alias |----o   |   |            alias|----o                                     |
                               |     +-----------------+            +-----------------+        |   +-----------------+                                          |
                               |     |                 |            |    alias_offset |--------o   |    alias_offset | -----------------------------------------o
                               |     +-----------------+            +-----------------+            +-----------------+               
                               |     |      subregions | <--------> | subregions_link | <--------> | subregions_link |
                               |     +-----------------+            +-----------------+            +-----------------+               
                               |     |                 |            |       container |--o         |       container |--o            
                               o---> +-----------------+            +-----------------+  |         +-----------------+  |            
                               |                                                         |                              |            
                               o---------------------------------------------------------o------------------------------o




                                                                                                                                 QEMU Address Space
                                                                                                                                 
                                                                                                                                 HVA:addr0                      HAV:addr1                                  HAV:addr2
                                                                                                  RAMBlock (RB0)                 |                              |                                          |
                                                                                                  +-----------------+            +------------------------------+------------------------------------------+
                                                                                                  |                 |            |                              |                                          |
                                                                                                  +-----------------+            |                              |                                          |
                                                                                                  |            host | -------->  +------------------------------+------------------------------------------+ 
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+            A <--------- size0 ----------> A <--------------- size1 ----------------> |
                                    +----------------+              +-----------------+           |            size |            |                              |
                                    |                |              |                 |           +-----------------+            |                              |
                                    +----------------+              +-----------------+           |                 |            |                              |
                                    |                |              |       ram_block | --------> +-----------------+            |                              |
                                    +----------------+              +-----------------+                                          |                              |
                               o----|           root |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+                                          |                              |
                               |    |                |              |                 |                                          |                              |
                               |    +----------------+              +-----------------+ <--o------------------------------o      |  o---------------------------o
                               |                                                           |                              |      |  |
                               |                                                           |                              |      |  |
                               |                                                           |   o-------------------------(+)-----o  |
                               |                                                           |   |                          |         |
                               |                                                           |   |                          |         |                
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |   |   MemoryRegion (R1)      |         |            MemoryRegion (R2)  
                               |     +-----------------+            +-----------------+    |   |   +-----------------+    |         |            +-----------------+
                               |     |                 |            |           alias |----o   |   |            alias|----o         |            |    alias_offset |--------o
                               |     +-----------------+            +-----------------+        |   +-----------------+              |            +-----------------+        |
                               |     |                 |            |    alias_offset |--------o   |    alias_offset | -------------o            |           alias |-----o  |
                               |     +-----------------+            +-----------------+            +-----------------+                           +-----------------+     |  |
                               |     |      subregions | <--------> | subregions_link | <--------> | subregions_link | <-----------------------> | subregions_link |     |  |
                               |     +-----------------+            +-----------------+            +-----------------+                           +-----------------+     |  |
                               |     |                 |            |       container |--o         |       container |--o                        |       container |--o  |  |
                               o---> +-----------------+            +-----------------+  |         +-----------------+  |                        +-----------------+  |  |  |
                               |                                                         |                              |                                             |  |  |
                               o---------------------------------------------------------o------------------------------o---------------------------------------------o  |  |
                                                                                                                                                                         |  |
                                                              o----------------------------------------------------------------------------------------------------------o  |
                                                              |                                                                                                             |
                                                              |                                                                  o------------------------------------------o
                                                              |                                                                  |
                                                              |                                                                  V
                                                              |                                     RAMBlock (RB1)               | <------------------------- size2 -------------------------> | 
                                                              |       MemoryRegion (R4)             +-----------------+          +-------------------------------------------------------------+
                                                              |       +-----------------+           |                 |          |                                                             |
                                                              |       |                 |           +-----------------+          |                                                             |
                                                              |       +-----------------+           |            host |--------> +-------------------------------------------------------------+
                                                              |       |                 |           +-----------------+          | 
                                                              |       +-----------------+           |            size |          HVA:adr3                                                      HVA:addr4
                                                              |       |                 |           +-----------------+
                                                              |       +-----------------+           |                 |          QEMU Address Space
                                                              |       |       ram_block | --------> +-----------------+
                                                              o-----> +-----------------+                              
                                                                                                   
                                                                                                    
                                                                                                    
                                                                      



                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                       
                                                                                                                                GPA:0        GPA:addr3                                            GPA:MAX
                                                                                                                                |            |                                                    |
                                                                                                                                +------------+----------------------------------------------------+
                                                                                                                                |            |                                                    |
                                                                                                                                +------------+----------------------------------------------------+
                                                                                                  RAMBlock (RB0)                             A
                                                                                                  +-----------------+                        |
                                                                                                  |          offset | -----------------------o
                                                                                                  +-----------------+
                                                                                                  |                 |
                                    AddressSpace                    MemoryRegion (R3)             +-----------------+           HVA:addr0               HVA:addr4                                 HAV:addr1
                                    +----------------+              +-----------------+           |            size |           |                       |                                         |
                                    |                |              |                 |           +-----------------+           +-----------------------+----+------------------------------------+
                                    +----------------+              +-----------------+           |            host | --------> |                       |    |                                    |
                                    |                |              |       ram_block | --------> +-----------------+           +-----------------------+----+------------------------------------+
                                    +----------------+              +-----------------+                                         A                       |
                               o----|           root |              |                 |                                         |                       |
                               |    +----------------+              +-----------------+                                         |                       |
                               |    |                |              |                 |                                         |                       V
                               |    +----------------+              +-----------------+ <--o                                    |              +-----------------+
                               |                                                           |                                    |              |   Page Tables   |
                               |                                                           |                                    |              +-----------------+
                               |                                                           |                                    |                       |
                               |                                                           |                                    |                       |
                               |                                                           |                                    |  HPA:0                | HPA:addr5                               HPA:MAX
                               |     MemoryRegion(Root)             MemoryRegion (R0)      |                                    |  |                    V                                         |
                               |     +-----------------+            +-----------------+    |                                    |  +--------------------+----+------------------------------------+
                               |     |                 |            |           alias |----o                                    |  |                    |    |                                    |
                               |     +-----------------+            +-----------------+                                         |  +--------------------+----+------------------------------------+
                               |     |                 |            |    alias_offset |-----------------------------------------o
                               |     +-----------------+            +-----------------+     
                               |     |      subregions | <--------> | subregions_link |                          
                               |     +-----------------+            +-----------------+                          
                               |     |                 |            |       container |--o                       
                               o---> +-----------------+            +-----------------+  |  
                               |                                                         |  
                               o---------------------------------------------------------o






                 TH000991.png





                 +-----------------------+                                                             +-------------------------+                        +-------------------------+
                 |                       |                                                             |                         |                spool   |                         |
                 | struct vm_area_struct |                                                             | struct hugetlbfs_config |            o---------->| struct hugepage_subpool |
                 |                       |                                                             |                         |            |           |                         |
                 +-----------------------+                                                             +-------------------------+            |           +-------------------------+
                            | vm_file                                                                                |                        |
                            V                                                                                        V                        |
                     +-------------+         +--------------+         +--------------------+           +--------------------------+           |           +---------------+
                     |             | f_inode |              |  i_sb   |                    | s_fs_info |                          |           |   hstate  |               |
                     | struct file |-------->| struct inode |-------->| struct super_block |---------->| struct hugetlbfs_sb_info |-----------o---------->| struct hstate |
                     |             |         |              |         |                    |           |                          |                       |               |
                     +-------------+         +--------------+         +--------------------+           +--------------------------+                       +---------------+





            Total = (1 << huge_page_shift(h)) * h->max_huge_pages * (size_opt)
                                                                    ----------
                                                                       100




                     struct hstate
                     +---------------------------+
                     |                           |
                     |        Counts Area        | 
                     |                           |
                     |             nr_huge_pages |
                     |           free_huge_pages |
                     |           resv_huge_pages |
                     |        surplus_huge_pages |
                     |   nr_overcommit_huge_page |
                     |      nr_huge_pages_node[] |
                     |    free_huge_pages_node[] |
                     | surplus_huge_pages_node[] |
                     +---------------------------+
                     |                           |
                     |        Linker Ares        |
                     |                           |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |       hugepage_activelist | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |                                                       
                     |                           |                                                       
                     |                           |      +----------+      +----------+      +----------+      +----------+      +----------+               +----------+
                     | hugepage_freelists[NODE0] | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |                                                       
                     |                   ....... |                                                       
                     |                           |                                                       
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     | hugepage_freelists[NODEn] | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> | HugePage | <--> ... <--> | HugePage |
                     |                           |      +----------+      +----------+      +----------+      +----------+               +----------+
                     |                           |
                     +---------------------------+
                     |      Base Information     |
                     |                           |
                     |                    name[] |
                     |                     order |
                     |                      mask |
                     +---------------------------+






                     nr_huge_pages = max_huge_pages + surplus_huge_pages




                    The Hugepge Pool

                    +------------------------------------------+----------------------+ <- Total_HugePages
                    |                                          |                      |
                    |              Free HugePages              |                      | <- Total_HugePages = Active_HugePages + Free_HugePages
                    |                                          |                      |
                    |---------------------+--------------------|                      |
                    |                     |                    |   Active HugePages   |
                    |                     |                    |                      |
                    |   Alloc HugePages   | Reserved HugePages |                      | <- Total_HugePages = Active_HugePages + (Alloc_HugePages + Reserved_HugePages)
                    |                     |                    |                      |
                    |                     +-----------+--------+                      |
                    |                     | GLOBAL_Rs |  Spool |                      | <- Total_HugePages = Active_HugePages + (Alloc_HugePages + (GLOBAL_RS + Spool))
                    +---------------------+-----------+--------+----------------------+
                    


                   The HugePage Pool

                   | <----- Total HugePages -----> | <--- nr_overcommit_huge_pages ---> |
                   +-------------------------------+
                   |      Persistent HugePage      |                                      <- Total_HugePages = Persisten_HugePages
                   +-------------------------------+
                                  |
                                  | Expand Pool
                                  |
                                  V
                                                   | <--- nr_overcommit_huge_pages ---> |
                   | <-------------------- Total HugePages --------------------> |
                   +-------------------------------+-----------------------------+
                   |      Persistent HugePage      |      Surplus HugePages      |        <- Total_HugePages = Persisten_HugePages + Surplus_HugePages
                   +-------------------------------+-----------------------------+
                                  |
                                  | Shrink Pool
                                  |
                                  V
                                                   | <--- nr_overcommit_huge_pages ---> |
                   | <--------------- Total HugePages ---------------> |
                   +-------------------------------+-------------------+
                   |      Persistent HugePage      | Surplus HugePages |                  <- Total_HugePages = Persisten_HugePages + Surplus_HugePages
                   +-------------------------------+-------------------+
            









                    +----------------+  +----------------+  +----------------+
                    |                |  |                |  |                |
                    |  ProcessA:VMA  |  |  ProcessB:VMA  |  |  ProcessC:VMA  |
                    |                |  |                |  |                |
                    +----------------+  +----------------+  +----------------+
                             |                   |                   |
                             |                   |                   |
                             |                   |                   |
                             o------------------(+)------------------o
                                                 |
                                       Anonymous | shared
                                                 V
                                      +----------------------+
                                      |                      |
                                      |   Hugetlb Hugepage   |
                                      |                      |
                                      +----------------------+






     vcpu_run
       |
       o-> vcpu_enter_guest
             |
             o-> kvm_mmu_reload
                   |
                   o-> kvm_mmu_load
                         |
                         o-> mmu_topup_memory_caches
                         |
                         o-> mmu_alloc_roots 
                         |     |
                         |     o-> mmu_alloc_direct_roots
                         |     |     |
                         |     |     o-> make_mmu_pages_available
                         |     |
                         |     o-> kvm_mmu_get_page
                         |
                         o-> kvm_mmu_load_cr3
                         |
                         o-> vmx_tlb_flush




                           +----------------+       +----------------------------+       +----------------+ 
                           |    输入设备    | ----> |           存储器           | ----> |    输出设备    |
                           +----------------+       +----------------------------+       +----------------+ 
                                   A                   |  A                |  A                  A
                                   |                   |  |                |  |                  |
                                   |             +-----|--|----------------|--|-----+            |
                                   |             |     V  |                V  |     |            |
                                   |             |  +--------+          +--------+  |            |
                                   |             |  | 运算器 |          | 控制器 |---------------o
                                   |             |  +--------+          +--------+  |
                                   |             |                           |      |
                                   o-----------------------------------------o      |
                                                 |                                  |
                                                 |                            CPU   |
                                                 +----------------------------------+



                                       
                                                         +-------------+    +------+                                         +-------------+
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                            冯诺依曼架构                 |             |    |      |            哈弗架构                     |             |
                            +---------------+            |             |    |      |            +---------------+            |             | 
                            |               |            |             |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            |               |            | Instruction |    |      |            |               |            |             |
                            |      CPU      | <--------> |      &      |    | Data | <--------> |      CPU      | <--------> | Instruction |
                            |               |            |    Data     |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            |               |            |             |    |      |            |               |            |             |
                            +---------------+            |             |    |      |            +---------------+            |             |
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                                                         |             |    |      |                                         |             |
                                                         +-------------+    +------+                                         +-------------+




                            +--------------------------------------------+     +--------------------------------------------+
                            |                                            |     |                                            |
                            |                                            |     |                                            |
                            |                    CPU                     |     |                    CPU                     |
                            |                                            |     |                                            |
                            |                                            |     |                                            |
                            +--------------------------------------------+     +--------------------------------------------+
                            |                CPU Register                |     |                CPU Register                |
                            +--------------------------------------------+     +--------------------------------------------+
                                               |     A                                            |     A                     
                                               V     |                                            V     |                     
                            +--------------------------------------------+     +--------------------------------------------+
                            |              CPU Cache Memory              |     |              CPU Cache Memory              |
                            +--------------------------------------------+     +--------------------------------------------+
                                               |     A                                            |     A                     
                                               V     |                                            V     |                     
                            +-----------------------------------------------------------------------------------------------+
                            |                                                                                               |
                            |                                         RAM Main Memory                                       |
                            |                                                                                               |
                            +-----------------------------------------------------------------------------------------------+
                                                                         |     A                                       
                                                                         |     |                                       
                                                                         V     |                                       
                            +-----------------------------------------------------------------------------------------------+
                            |                                                                                               |
                            |                         Storage: Disk/SSD/NVMe/STA/ESSD/Floppy/CD-ROM                         |
                            |                                                                                               |
                            +-----------------------------------------------------------------------------------------------+





                            +-------------+           +--------+            +---------+              +-------------+            +-------+              +----------+       +-----+
                            |             |  Compile  |        |  Install   |         |  read/write  |             |  Hit/Miss  |       |  load/store  |          |  MOV  |     |
                            | Source Code | --------> | Binary | ---------> | Storage | <----------> | Main Memory | <--------> | Cache | <----------> | Register | <---> | CPU |
                            |             |           |        |            |         |              |             |            |       |              |          |       |     |
                            +-------------+           +--------+            +---------+              +-------------+            +-------+              +----------+       +-----+




                            +----+
                            |    | Register
                            +----+
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            | | | | | | | | | | | | | | | TLB
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            +----+----+----+----+----+----+----+----+
                            |    |    |    |    |    |    |    |    | Cache
                            +----+----+----+----+----+----+----+----+
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | 
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | Main Memory 
                            | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | |
                            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            +----+----+----+----+-------------------------------------------------------------------------------+----+----+
                            |    |    |    |    |                                                                               |    |    |
                            |File|File|File|File| ............................................................................. |File|File| Disk Storage
                            |    |    |    |    |                                                                               |    |    |
                            +----+----+----+----+-------------------------------------------------------------------------------+----+----+

                            


                            +-----+                                                           +-----------------+
                            |     |-+                                                         |                 |
                            |     | |------addr[31]------>|                                   |                 |
                            |     | |------addr[30]------>|           Address Bus             |                 |
                            |     | |------........------>|=================================> |                 |
                            |     | |------addr[1]------->|                                   |                 |
                            |     | |------addr[0]------->|                                   |                 |
                            |     |-+                                                         |                 |
                            | CPU |                                                           |   Main Memory   |
                            |     |-+                                                         |                 |
                            |     | |<-----data[31]------>|                                   |                 |
                            |     | |<-----data[30]------>|             Data Bus              |                 |
                            |     | |<-----........------>|<================================> |                 |
                            |     | |<-----data[1]------->|                                   |                 |
                            |     | |<-----data[0]------->|                                   |                 |
                            |     |-+                                                         |                 |
                            |     |                                   Control Bus             |                 |
                            |     |=========================================================> |                 |
                            +-----+                                                           +-----------------+


                            +-----+                                                                    Main Memory
                            |     |                                                                    +-----------------+ -----
                            |     |                                                                    |       ...       |   A
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | ADR:0x100000001 | Unaddressable
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | ADR:0x100000000 |   V
                            |     |                                                                    +-----------------+ -----
                            | CPU |                                                                    | Addr:0xffffffff |   A
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    | Addr:0xfffffffe |   |
                            |     |                                                                    +-----------------+   |
                            |     |                                                                    |       ...       |   |
                            |     |                                                                    +-----------------+   |
                            |     | Address Bus                                                        | Address:0x10002 |   |
                            |     | -----------------------addr[31]------------------------> |         +-----------------+   |
                            |     | -----------------------addr[30]------------------------> |         | Address:0x10001 | Addressable
                            |     | -----------------------addr[29]------------------------> |         +-----------------+   |
                            |     | -----------------------addr[28]------------------------> |         | Address:0x10000 |   |
                            |     | -----------------------.......-------------------------> |=======> +-----------------+   |
                            |     | -----------------------addr[3]-------------------------> |         | Address:0x0ffff |   |
                            |     | -----------------------addr[2]-------------------------> |         +-----------------+   |
                            |     | -----------------------addr[1]-------------------------> |         |       ...       |   |
                            |     | -----------------------addr[0]-------------------------> |         +-----------------+   |              
                            +-----+                                                                    | Adderss:0x00001 |   |
                                                                                                       +-----------------+   |
                                                                                                       | Address:0x00000 |   V
                                                                                                       +-----------------+ -----



                     


                          Physical Memory 

                          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                          | | | | | | | | | | | | | | | | | | | | | | |         | | | | | | | | | | | | | | | | | | | | | | | |
                          | | | | | | | | | | | | | | | | | | | | | | |  .....  | | | | | | | | | | | | | | | | | | | | | | | |
                          | | | | | | | | | | | | | | | | | | | | | | |         | | | | | | | | | | | | | | | | | | | | | | | |
                          +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---------+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                           | | | | | | |  | |
                           0 1 2 3 4 5 6  | o----
                                          |    A
                                          |    |
                                          |  1 Byte
                                          |    |
                                          |    V
                                          o------

                          Physical Memory
                                            | <- PAGE_SIZE -> |
                          +-----------------+-----------------+---------+-----------------+----------------+-----------------+
                          |                 |                 |         |                 |                |                 |
                          |                 |                 |  ....   |                 |                |                 |
                          |                 |                 |         |                 |                |                 |
                          +-----------------+-----------------+---------+-----------------+----------------+-----------------+
                          |                 |                                          
                          PFN:0             PFN:1
                           


                                      +--------+     +-----------+      +------------+     +---------+
                                      |        |     |           |      |            |     |         |
                                      |  CMOS  |     | Interrupt |      |    DMA     |     |  Timer  |
                                      |        |     |           |      | Controller |     |         |
                                      +--------+     +-----------+      +------------+     +---------+
                                         A A A           A A A              A A A             A A A
                                         | | |           | | |              | | |             | | |
                         +-----------+   | | |           | | |              | | |             | | |
                         |           |--(+)|-|----------(+)|-|-------------(+)|-|------------(+)|-|----------> Address Bus
                         |    CPU    |<--|(+)|-----------|(+)|--------------|(+)|-------------|(+)|----------> Data Bus
                         |           |---|-|(+)----------|-|(+)-------------|-|(+)------------|-|(+)---------> Control Bus
                         +-----------+   | | |           | | |              | | |             | | |
                                         | | |           | | |              | | |             | | |
                                         V V V           V V V              V V V             V V V     
                                     +----------+     +---------+        +---------+       +--------+   
                                     |          |     |         |        |         |       |        |   
                                     |  Memory  |     | Display |        | Printer |       |  Disk  |   
                                     |          |     |         |        |         |       |        |   
                                     +----------+     +---------+        +---------+       +--------+   


                         Address Bus Space
                         0                                                                                           0x100000000
                         |                                                                                           |
                         +------+-------------+---------+-----------+-------------+---------+------+----------+--------+---------+
                         |      |             |         |           |             |         |      |          |        |         |
                         | CMOS | Main Memory | PCI BUS | Video ROM | Main Memory | PCI BUS | HPET | Reserved | IOAPCI | PCI BUS |
                         |      |             |         |           |             |         |      |          |        |         |
                         +------+-------------+---------+-----------+-------------+---------+------+----------+--------+---------+
                      

			 Main Memory
                                           | <- PAGE_SIZE -> |
                         +-----------------+-----------------+--------------+-----------------+----------------+-----------------+
                         |                 |                 |              |                 |                |                 |
                         |                 |                 |     ....     |                 |                |                 |
                         |                 |                 |              |                 |                |                 |
                         +-----------------+-----------------+--------------+-----------------+----------------+-----------------+
                         |                                                           
                         PFN = PHYS>>PAGE_SHIFT
                           



                         Virtual Memory Space                     
                       
                         +-------------------------------------------------------------------+----------------------------------+
                         |                                                                   |                                  |
                         |                                                                   |                                  |
                         |                                                                   |                                  |
                         +-------------------------------------------------------------------+----------------------------------+
                         | <-------------------------- UserSpace --------------------------> | <-------- Kernel Space --------> |
                         |                                                                   |
                         0                                                                   PAGE_OFFSET

                         Physical Memory Space

                         +---------------------------------------------------+
                         |                                                   |
                         |                                                   |
                         |                                                   |
                         +---------------------------------------------------+
                         |                                                   |
                         PFN:X                                               PFN:Y






                       Page Table on Translation to a 4KiB Page using 32-Bit Paging

                        31                         22 21                       12 11                             0
                       +-----------------------------+---------------------------+--------------------------------+
                       |          Directroy          |           Table           |             Offset             |
                       +-----------------------------+---------------------------+--------------------------------+
                                      |                            |
                                      |                            |
                                      |                            |
                                      |                            |   Page Table
                                      |                            |   +---------------+
                                      |                            |   |               |
                                      |   Page Directory           |   +---------------+
                                      |   +---------------+        |   |               |
                                      |   |               |        |   +---------------+
                                      |   +---------------+        o-> | PTE with PS=0 |
                                      |   |               |            +---------------+
                                      |   +---------------+            |               |
                                      |   |               |            +---------------+
                                      |   +---------------+            |               |
                                      |   |               |     o----> +---------------+
                                      |   +---------------+     |
                                      o-> | PDE with PS=0 | ----o
                                          +---------------+
                       +-----------+      |               |
                       |    CR3    | ---> +---------------+
                       +-----------+





                       Virtual Memory Space
                       0                                                           PAGE_OFFSET
                       | <---------------------- UserSpace ----------------------> | <--------- Kernel Space --------> |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----+
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |     |
                       |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |     |
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----+
                                |     |           |
                                |     |           |
                          o-----o     |     o-----o
                          |           |     |
                          V           V     V
                       +-----+-----+-----+-----+-----+-----------+-----+-----+
                       |     |     |     |     |     |           |     |     |
                       |     |     |     |     |     |    ...    |     |     | Physical Memory Space
                       |     |     |     |     |     |           |     |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+
                       |           |     |
                       PFN:n       PFN:m PFN:x
                  
                      


                       Virtual Memory Space
                       0                                                           PAGE_OFFSET
                       | <---------------------- UserSpace ----------------------> | <--------------- Kernel Space --------------> |
                       |                                                           | <- Linear Mapping Spaces -> |                 |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |           |     |
                       |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |    ...    |     |
                       |     |     |     |     |     |           |     |     |     |     |     |     |     |     |           |     |
                       +-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      |     |     |     |     |
                                                                                      V     V     V     V     V
                                                                                   +-----+-----+-----+-----+-----+-----------+-----+
                                                                                   |     |     |     |     |     |           |     |
                                                             Physical Memory Space |     |     |     |     |     |    ...    |     |
                                                                                   |     |     |     |     |     |           |     |
                                                                                   +-----+-----+-----+-----+-----+-----------+-----+
                                                                                   |           |           |
                                                                                   PFN:n       PFN:n+2     PFN:n+4
                  
                      




                                                                    struct memblock_region
                                                  struct            +------+------+--------+------+
                                                  memblock_type     |      |      |        |      |
                                                  +----------+      | Reg0 | Reg1 | ...    | Regn |
                                                  |          |      |      |      |        |      |
                                                  | regions -|----->+------+------+--------+------+
                                                  | cnt      |      [memblock_memory_init_regions]
                                                  |          |
                            struct           o--->+----------+
                            memblock         |
                            +-----------+    |
                            |           |    |
                            | memory   -|----o
                            | reserved -|----o
                            |           |    |                      struct memblock_region
                            +-----------+    |    struct            +------+------+--------+------+
                                             |    memblock_type     |      |      |        |      |
                                             o--->+----------+      | Reg0 | Reg1 | ...    | Regn |
                                                  |          |      |      |      |        |      |
                                                  | regions -|----->+------+------+--------+------+
                                                  | cnt      |      [memblock_reserved_init_regions]
                                                  |          |
                                                  +----------+





                             MEMBLOCK Allocator

                                                               struct memblock_type       struct memblock_region                        
                                                               +-------------------+      +--------+--------+--------+---------+--------+
                                                               |                   |      |        |        |        |         |        |
                             struct memblock              o--> |                   |----> |  Reg0  |  Reg1  |  Reg2  |   ...   |  Regn  |
                             +--------------+             |    |                   |      |        |        |        |         |        |
                             |              |   memory    |    +-------------------+      +--------+--------+--------+---------+--------+
                             |              |-------------o
                             |              |            
                             |              |-------------o    struct memblock_type       struct memblock_region                        
                             |              |  reserved   |    +-------------------+      +--------+--------+--------+---------+--------+
                             +--------------+             |    |                   |      |        |        |        |         |        |
                                                          o--> |                   |----> |  Reg0  |  Reg1  |  Reg2  |   ...   |  Regn  |
                                                               |                   |      |        |        |        |         |        |
                                                               +-------------------+      +--------+--------+--------+---------+--------+



                            Flat Model

                            struct page mem_map[]
                            +-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                            | | | | | | | | | |       | | | | | | |
                            | | | | | | | | | |  ...  | | | | | | |
                            | | | | | | | | | |       | | | | | | |
                            +-+-+-+-+-+-+-+-+-+-------+-+-+-+-+-+-+
                             | | | | |
                             | | | | o---------------o
                             | | | o-----------o     |
                             | | o-------o     |     |
                             | o---o     |     |     |
                             |     |     |     |     |             Physical Memory Space
                             V     V     V     V     V                
                             +-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+
                             |     |     |     |     |     |     |     |     |           |     |     |     |     |     |     |     |     |
                             |     |     |     |     |     |     |     |     |    ...    |     |     |     |     |     |     |     |     |
                             |     |     |     |     |     |     |     |     |           |     |     |     |     |     |     |     |     |
                             +-----+-----+-----+-----+-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----+-----+-----+
                             |           |           |
                             PFN:n       PFN:n+2     PFN:n+4


                           SPARSE Model

                           struct mem_section
                           +-+-+---+-+-+-+-+-+-+
                           | | |   | | | | | | |
                           | | | . | | | | | | | SECTION_ROOT
                           | | |   | | | | | | |
                           +-+-+---+-+-+-+-+-+-+                  struct mem_section                   struct page []                           
                              |       |                           +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+
                              |       |                           |                 | section_mem_map  | | | | | |     | | | | |
                              |       o-------------------------> |                 |----------------> | | | | | | ... | | | | |
                              |                                   |                 |                  | | | | | |     | | | | |
                              |                                   +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+
                              |                                                                         | |
                              |     struct mem_section                   struct page []                 | |
                              |     +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+      | |
                              |     |                 | section_mem_map  | | | | | |     | | | | |      | | 
                              o---> |                 |----------------> | | | | | | ... | | | | |      | |
                                    |                 |                  | | | | | |     | | | | |      | |
                                    +-----------------+                  +-+-+-+-+-+-----+-+-+-+-+      | |
                                                                          | |                           | |
                                                                          | o---o                       | o---o
                                                                          |     |                       |     |
                              Physical Memory                             V     V                       V     V
                              +-----+-----+-----+-----+-------------------+-----+-----+-----+-----+     +-----+-----+-----+-----+
                              |     |     |     |     |                   |     |     |     |     |     |     |     |     |     |
                              |     |     | ... |     |        ...        |     |     | ... |     |     |     |     | ... |     |
                              |     |     |     |     |                   |     |     |     |     |     |     |     |     |     |
                              +-----+-----+-----+-----+-------------------+-----+-----+-----+-----+     +-----+-----+-----+-----+
                              |           |           |                   | <--- SECTION_SIZE --> |     | <--- SECTION_SIZE --> |
                              PFN:n       PFN:n+2     PFN:n+4



                                16MiB                 896MiB                  4G
                                |                     |                       |
               +----------------+---------------------+-----------------------+
               |                |                     |                       |
          IA32 |                |                     |                       |
               |                |                     |                       |
               +----------------+---------------------+-----------------------+
               | <- ZONE_DMA -> | <-- ZONE_NORMAL --> | <---- ZONE_HIGH ----> |


                                16MiB                                         4Gig                              
                                |                                             |                                 
               +----------------+---------------------------------------------+-----------------------------------------+
               |                |                                             |                                         |
         AMD64 |                |                                             |                                         |
               |                |                                             |                                         |
               +----------------+---------------------------------------------+-----------------------------------------+
               | <- ZONE_DMA -> | <-------------- ZONE_DMA32 ---------------> | <------------ ZONE_NORMAL ------------> |




               
                                   ---------------+---------------+------------------
                                                  |               |
               Kernel Space                       |               |
                                                  |               |
                                   ---------------+---------------+------------------
                                                  |               |                      
                                                  |               |                      
                                                  V               V
                                   ---------------+-------------------------+--------
                                                  |                         |        
               Physical Memory                    |         CMA/DMA         |        
                                                  |                         |        
                                   ---------------+-------------------------+--------



               Virtual Memory Space          
                                                                                    
               +------------------------------------------------+        +--------------------------------------+
               |                                                |        |                                      |
               |                    Userspace                   | <----> |             Kernel Space             |
               |                                                |        |                                      |
               +------------------------------------------------+        +--------------------------------------+
 


               IA32 Virtual Memory Space
                
               0                                                      PAGE_OFFSET                              4G
               |                                                      |                                        |
               +------------------------------------------------------+----------------------------------------+
               |                                                      |                                        |
               |                      Userspace                       |              Kernel Space              |
               |                                                      |                                        |
               +------------------------------------------------------+----------------------------------------+

               IA32 Virtual Address

                31                                                                                            0
               +-----------------------------------------------------------------------------------------------+
               |                                        Linear Address                                         |
               +-----------------------------------------------------------------------------------------------+



 

               AMD64 48-bit implementation Virtual Memory Space


               | <-------- USerspace -------> |                                        | <------ Kernel Space ------> |
               +------------------------------+----------------------------------------+------------------------------+
               |                              |                                        |                              |
               |    Canonical "Lower half"    |       Noncanonical Address Space       |    Canonical "Higer half"    |
               |                              |                                        |                              |
               +------------------------------+----------------------------------------+------------------------------+
               | <--------- 128TiB ---------> |                                        | <--------- 128TiB ---------> |
               0                              0x00007FFFFFFFFFFF                       0xFFFF800000000000             |
                                                                                                      0xFFFFFFFFFFFFFFF

               AMD64 56-bit implementation Virtual Memory Space

               | <----------- USerspace ----------> |                            | <--------- Kernel Space ---------> |
               +------------------------------------+----------------------------+------------------------------------+
               |                                    |                            |                                    |
               |       Canonical "Lower half"       | Noncanonical Address Space |       Canonical "Higer half"       |
               |                                    |                            |                                    |
               +------------------------------------+----------------------------+------------------------------------+
               | <------------ 32PiB -------------> |                            | <------------ 32PiB -------------> |
               0                                    0x007FFFFFFFFFFFFF           0xFF80000000000000                   |
                                                                                                      0xFFFFFFFFFFFFFFF
   
               AMD64 64-bit implementation Virtual Memory Space

               | <------------------ USerspace -----------------> | <---------------- Kernel Space -----------------> |
               +--------------------------------------------------+---------------------------------------------------+
               |                                                  |                                                   |
               |                    Lower half                    |                    Higher half                    |
               |                                                  |                                                   |
               +--------------------------------------------------+---------------------------------------------------+
               | <------------------- 16EiB --------------------> | <------------------- 16EiB ---------------------> |
               0                                                  0x8000000000000000                                  |
                                                                                                      0xFFFFFFFFFFFFFFF
                                       

                     
              AMD64/X64 Virtual Address

               63            48 47                                                                                   0
              +----------------+--------------------------------------------------------------------------------------+
              | Sign Extension |                                    Linear Address                                    |
              +----------------+--------------------------------------------------------------------------------------+




                        Process Address Space Layout          

                                 --- +------------------------------------+ <-- 0xffffffff
                                  A  |                                    |
                                  |  |                                    |
                            Share |  |            Kernel Space            |
                                  |  |                                    |
                                  V  |                                    |
                                 --- +------------------------------------+ <-- PAGE_OFFSET
                                  A  |            argv,environ            |
                                  |  +------------------------------------+ <-- Stack bottom
                                  |  |              Stack                 |
                                  |  |                |                   |
                                  |  |                |                   |
                                  |  |                V                   |
                                  |  +------------------------------------+ <-- Stack top
                                  |  |                                    |
                                  |  |                                    |
                                  |  |          Unallocate Areas          |
                                  |  |                                    |
                                  |  |                                    |
                                  |  +------------------------------------+ ---
                                  |  |                                    |  A
                                  |  |             MMAP Areas             |  | mmap()/malloc(big)
                                  |  |                                    |  V
                        Userspace |  +------------------------------------+ ---
                                  |  |                                    |
                                  |  |          Unallocate Areas          |
                                  |  |                                    |
                                  |  +------------------------------------+ ---
                                  |  |                A                   |  A
                                  |  |                |                   |  | brk()/malloc(small)
                                  |  |               Heap                 |  V
                                  |  +------------------------------------+ ---
                                  |  |              .bss                  |  A
                                  |  +------------------------------------+  |
                                  |  |                                    |  | Data Segment
                                  |  |              .data                 |  |
                                  |  |                                    |  V
                                  |  +------------------------------------+ ---
                                  |  |                                    |  A
                                  |  |              .text                 |  | Code Segment
                                  |  |                                    |  V
                                  |  +------------------------------------+ <-- __executable_start
                                  V  |            Reserved Area           |
                                 --- +------------------------------------+ <-- 0x00000000
    






                  Virtual Memory Space
                            
            
                            | <------------------------------- Userspace -------------------------------> |         | <---- Kernel Space ----> |

                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+
                            |     |       |       |      |         |     |        |     |           |     |
                  Process0  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <--o
                            |     |       |       |      |         |     |        |     |           |     |    |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |
                                                                                                               |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |    +--------------------------+
                            |     |       |       |      |         |     |        |     |           |     |    o--> |                          |
                  Process1  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <-----> |       Kernel Space       |
                            |     |       |       |      |         |     |        |     |           |     |    o--> |                          |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |    +--------------------------+
                                                                                                               |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+    |
                            |     |       |       |      |         |     |        |     |           |     |    |
                  Process2  | RSV | .text | .data | .bss | Heap -> | ... |  MMAP  | ... | <- Stack  | Env | <--o
                            |     |       |       |      |         |     |        |     |           |     |
                            +-----+-------+-------+------+---------+-----+--------+-----+-----------+-----+




                          32-Bit Paging

                           31                             22 21                             12 11                       0
                          +---------------------------------+---------------------------------+--------------------------+
                          |            Directory            |              Table              |          Offset          |
                          +---------------------------------+---------------------------------+--------------------------+
                                           |                                 |                              |
                                           |                                 |                              |   4KiB Page
                                           |                                 |                              |   +---------------+
                                           |                                 |                              |   |               |
                                           |                                 |                              |   +---------------+
                                           |                                 |                              o-> | Physical Addr |
                                           |                                 |   Page Table                     +---------------+
                                           |                                 |   +---------------+              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   |               |              |               |
                                           |                                 |   +---------------+              |               |
                                           |   Page Directory                o-> |      PTE      | -----------> +---------------+
                                           |   +---------------+                 +---------------+
                                           |   |               |                 |               |
                                           |   |               |                 |               |
                                           |   +---------------+                 |               |
                                           o-> |      PDE      | ------------->  +---------------+
                                               +---------------+
                                               |               |
                                               |               |
                                               |               |
                          +-------+            |               |
                          |  CR3  | ---------> +---------------+
                          +-------+                           
                  



                          4-level Paging

                           47              39 38                  30 29              21 20                12 11                   0
                          +------------------+----------------------+------------------+--------------------+---------------------+
                          |       PML4       |    Directory Ptrs    |     Directory    |       Table        |        Offset       |
                          +------------------+----------------------+------------------+--------------------+---------------------+
                                   |                     |                    |                  |                      |
                                   |                     |                    |                  |                      |   4KiB Page
                                   |                     |                    |                  |                      |   +---------------+
                                   |                     |                    |                  |                      |   |               |
                                   |                     |                    |                  |                      |   +---------------+
                                   |                     |                    |                  |                      o-> | Physical Addr |
                                   |                     |                    |                  |   Page Table             +---------------+ 
                                   |                     |                    |                  |   +-----------+          |               |
                                   |                     |                    |                  |   |           |          |               |
                                   |                     |                    |                  |   |           |          |               |
                                   |                     |                    |   Page-Directory |   |           |          |               |
                                   |                     |                    |   +-----------+  |   +-----------+          |               |
                                   |                     |                    |   |           |  o-> |    PTE    | -------> +---------------+
                                   |                     |   Page-Directory   |   |           |      +-----------+      
                                   |                     |   Pointer Table    |   |           |      |           |      
                                   |                     |   +-----------+    |   +-----------+      |           |      
                                   |                     |   |           |    o-> |    PDE    | ---> +-----------+      
                                   |                     |   |           |        +-----------+                         
                                   |   PML4 Table        |   |           |        |           |                         
                                   |   +-----------+     |   +-----------+        |           |                         
                                   |   |           |     o-> |   PDPTE   | -----> +-----------+
                                   |   |           |         +-----------+                      
                                   |   |           |         |           |         
                                   |   +-----------+         |           |         
                                   o-> |   PML4E   | ------> +-----------+         
                                       +-----------+
                                       |           |
                          +-------+    |           |
                          |  CR3  | -> +-----------+
                          +-------+


                                                              5-level Paging
  
                                                               55              48 47              39 38                  30 29              21 20                12 11                   0
                                                              +------------------+------------------+----------------------+------------------+--------------------+---------------------+
                                                              |       PML5       |       PML4       |    Directory Ptrs    |     Directory    |       Table        |        Offset       |
                                                              +------------------+------------------+----------------------+------------------+--------------------+---------------------+
                                                                       |                  |                     |                    |                  |                      |
                                                                       |                  |                     |                    |                  |                      |   4KiB Page
                                                                       |                  |                     |                    |                  |                      |   +---------------+
                                                                       |                  |                     |                    |                  |                      |   |               |
                                                                       |                  |                     |                    |                  |                      |   +---------------+
                                                                       |                  |                     |                    |                  |                      o-> | Physical Addr |
                                                                       |                  |                     |                    |                  |   Page Table             +---------------+
                                                                       |                  |                     |                    |                  |   +-----------+          |               |
                                                                       |                  |                     |                    |                  |   |           |          |               |
                                                                       |                  |                     |                    |                  |   |           |          |               |
                                                                       |                  |                     |                    |   Page-Directory |   |           |          |               |
                                                                       |                  |                     |                    |   +-----------+  |   +-----------+          |               |
                                                                       |                  |                     |                    |   |           |  o-> |    PTE    | -------> +---------------+
                                                                       |                  |                     |   Page-Directory   |   |           |      +-----------+
                                                                       |                  |                     |   Pointer Table    |   |           |      |           |
                                                                       |                  |                     |   +-----------+    |   +-----------+      |           |
                                                                       |                  |                     |   |           |    o-> |    PDE    | ---> +-----------+
                                                                       |                  |                     |   |           |        +-----------+
                                                                       |                  |   PML4 Table        |   |           |        |           |
                                                                       |                  |   +-----------+     |   +-----------+        |           |
                                                                       |                  |   |           |     o-> |   PDPTE   | -----> +-----------+
                                                                       |                  |   |           |         +-----------+
                                                                       |   PML5 Table     |   |           |         |           |
                                                                       |   +-----------+  |   +-----------+         |           |
                                                                       |   |           |  o-> |   PML4E   | ------> +-----------+
                                                                       |   |           |      +-----------+
                                                                       |   |           |      |           |
                                                                       |   +-----------+      |           |
                                                                       o-> |   PML5E   | ---> +-----------+
                                                                           +-----------+
                                                                           |           |
                                                              +-------+    |           |
                                                              |  CR3  | -> +-----------+
                                                              +-------+

                         




