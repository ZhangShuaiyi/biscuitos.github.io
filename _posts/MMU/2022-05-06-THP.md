---
layout: post
title:  "THP: Transport Huge Pages Mechanism"
date:   2022-05-06 09:00:00 +0800
categories: [HW]
excerpt: THP.
tags:
  - 透明大页
  - AnonHugePages
  - ShmemHugePages
  - ShmemPmdMapped
---

![](/assets/PDB/BiscuitOS/kernel/IND00000L0.PNG)

![](/assets/PDB/RPI/RPI100100.png)

#### 目录

> - [THP 基础知识](#A)
>
> - [THP 实践攻略](#B)
>
> - [THP 使用手册](#C)
>
> - [THP 源码分析](#D)
>
> - [THP 开源工具](#E)
>
> - THP 进阶研究

######  🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂 捐赠一下吧 🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂🙂

![BiscuitOS](/assets/PDB/BiscuitOS/kernel/HAB000036.jpg)

-------------------------------------------

<span id="C"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### THP 使用手册

![](/assets/PDB/HK/TH001565.png)

本节基于丰富的实例案例来介绍 THP 的使用，实践案例已经在 BiscuitOS 适配，开发者可以参考部署流程在 BiscuitOS 直接实践案例:

> - [匿名共享映射直接分配一个 ShmemHugepage 大页](#C00C00)
>
> - [文件(私有/共享)映射直接分配一个 ShmemHugepage 大页](#C00C01)
>
> - [匿名私有映射直接分配一个 AnonHugepage 大页](#C00C02)

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C00"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000Q.jpg)

#### 匿名共享映射直接分配一个 ShmemHugepage 大页

在启用透明大页的系统中，如果对 ShmemHugepage 的策略是 always 时，进程通过匿名共享方式分配 2MiB 虚拟内存时，只要访问 2MiB 虚拟内存任意位置是，系统直接分配一个 ShmemHugepage 物理页与 2MiB 虚拟内存建立页表映射关系。为了更好实践 ShmemHugepages，内核必须启用 **CONFIG_TRANSPARENT_HUGEPAGE** 宏和 **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** 宏。本节用于介绍应用程序分配 ShmemHugepage 的方法, BiscuitOS 提供了使用案例，其在 BiscuitOS 上部署逻辑如下:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: 内核版本字段 e.g. 5.0
# ARCHITECTURE: 架构字段 e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an Anonymous ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# 下载案例源码
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-anonymous-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-anonymous)
>
> [BiscuitOS 独立模块部署手册](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001608.png)
![](/assets/PDB/HK/TH001609.png)
![](/assets/PDB/HK/TH001610.png)

案例源码通过一个应用程序进行展示，应用程序首先在 29 行调用 mmap() 函数，通过匿名共享映射的方式分配了 BISCUITOS_MAP_SIZE 的虚拟内存，通过宏定义可以知道虚拟内存大小为 8MiB，那么接下来在 44-47 行分别按 2MiB 的偏移对虚拟内存进行访问，可以看到每个 2MiB 的虚拟区域都被访问了一次。为了调试方便进程在 50 行处调用 sleep(-1) 保持不退出. 至此程序的功能完结，案例代码很精简，另外当系统启动之后需要设置 THP 的 ShmemHugepage 策略为 always, 那么接下来通过下面的命令在 BiscuitOS 上进行实践:

{% highlight bash %}
# 进入源码目录
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# 编译源码
make
# 安装驱动
make install
# Rootfs 打包
make pack
# 运行 BiscuitOS
make run

# THP Enable ShmemHugepage always
echo always > /sys/kernel/mm/transparent_hugepage/shmem_enabled

# 后台方式运行程序
BiscuitOS-THP-ShmemHugepage-anonymous-default &

# 查看 ShmemHugepage 使用情况
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001611.png)

可以看到当系统启动之后，向 "/sys/kernel/mm/transparent_hugepage/shmem_enabled" 写入 always 时，那么 THP 的 ShmemHugepage 策略就是直接分配. 接着后台运行应用程序 BiscuitOS-THP-ShmemHugepage-anonymous-default，此时查看 ShmemHugepage 的使用情况，可以看出此时进程占用了 4 个 ShmemHugepage 大页，总共 8MiB 物理内存，这与源码访问 8MiB 虚拟内存对应. 至此实践完毕符合预期.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C01"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000T.jpg)

#### 文件(私有/共享)映射直接分配一个 ShmemHugepage 大页

在启用透明大页的系统中，如果挂载了一个带 "huge=always" 参数的 tmpfs 文件系统时，进程在该 tmpfs 文件系统下通过文件(共享/私有)映射方式分配 2MiB 虚拟内存时，只要访问 2MiB 虚拟内存任意位置是，系统直接分配一个 ShmemHugepage 物理页与 2MiB 虚拟内存建立页表映射关系。为了更好实践 ShmemHugepages，内核必须启用 **CONFIG_TRANSPARENT_HUGEPAGE** 宏和 **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** 宏。本节用于介绍应用程序分配 ShmemHugepage 的方法, BiscuitOS 提供了使用案例，其在 BiscuitOS 上部署逻辑如下:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: 内核版本字段 e.g. 5.0
# ARCHITECTURE: 架构字段 e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an File ShmemHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-default/
# 下载案例源码
make download
{% endhighlight %} 

> [BiscuitOS-THP-ShmemHugepage-file-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-ShmemHugepage-file)
>
> [BiscuitOS 独立模块部署手册](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001612.png)
![](/assets/PDB/HK/TH001613.png)
![](/assets/PDB/HK/TH001614.png)

案例源码通过一个应用程序进行展示，应用程序首先在 31 行通过 open() 函数以可读可写的方式打开文件，如果文件 BiscuitOS 不存在，那么创建 BiscuitOS 文件，程序接着在 38 行调用 write() 函数向 BiscuitOS 文件后端写入数据。然后程序在 41 行调用 mmap() 函数，通过文件共享(也可以是私有)映射的方式分配了 BISCUITOS_MAP_SIZE 的虚拟内存，通过宏定义可以知道虚拟内存大小为 8MiB，该虚拟内存用于映射 BiscuitOS 文件。那么接下来在 57 行对虚拟内存进行访问。为了调试方便进程在 60 行处调用 sleep(-1) 保持不退出. 至此程序的功能完结，案例代码很精简，另外当系统启动之后需要挂载一个带 "huge=always" 参数的 tmpfs 文件系统，并在文件系统中打开该文件, 那么接下来通过下面的命令在 BiscuitOS 上进行实践:

{% highlight bash %}
# 进入源码目录
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-file-default/
# 编译源码
make
# 安装驱动
make install
# Rootfs 打包
make pack
# 运行 BiscuitOS
make run

# 挂载 huge tmpfs
mkdir -p /BiscuitOS-tmpfs/
mount -t tmpfs nodev -o huge=always /BiscuitOS-tmpfs/

# 后台方式运行程序
BiscuitOS-THP-ShmemHugepage-file-default &

# 查看 ShmemHugepage 使用情况
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001615.png)

可以看到当系统启动之后，挂载一个 huge tmpfs 之后在后台运行应用程序 BiscuitOS-THP-ShmemHugepage-file-default，此时查看 ShmemHugepage 的使用情况，可以看出此时进程占用了 1 个 ShmemHugepage 大页，总共 2MiB 物理内存，这与源码访问 2MiB 虚拟内存对应. 至此实践完毕符合预期.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

-------------------------------------------

<span id="C00C02"></span>

![](/assets/PDB/BiscuitOS/kernel/IND00000I.jpg)

#### 匿名私有映射直接分配一个 AnonHugepage 大页

在启用透明大页的系统中，如果对 THP 的策略是 always 时，并且系统物理内存大于 512MiB，那么进程通过匿名私有方式分配 2MiB 虚拟内存时，只要访问 2MiB 虚拟内存任意位置是，系统直接分配一个 AnonHugepage 物理页与 2MiB 虚拟内存建立页表映射关系。为了更好实践 AnonHugepages，内核必须启用 **CONFIG_TRANSPARENT_HUGEPAGE** 宏和 **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS** 宏, 并且系统物理内存大于 512MiB。本节用于介绍应用程序分配 AnonHugepage 的方法, BiscuitOS 提供了使用案例，其在 BiscuitOS 上部署逻辑如下:

{% highlight bash %}
cd BiscuitOS/
# KERNEL_VERSION: 内核版本字段 e.g. 5.0
# ARCHITECTURE: 架构字段 e.g x86_64 or i386
make linux-${KERNEL_VERSION}-${ARCHITECTURE}_defconfig
make menuconfig

  [*] Package --->
      [*] THP: Transparent hugepage mechanism --->
          [*]  THP: Alloc an AnonHugepage --->

make
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-AnonHugepage-default/
# 下载案例源码
make download
{% endhighlight %} 

> [BiscuitOS-THP-AnonHugepage-default Gitee Source Code](https://gitee.com/BiscuitOS_team/HardStack/tree/Gitee/Memory-Allocator/THP/BiscuitOS-THP-AnonHugepage)
>
> [BiscuitOS 独立模块部署手册](https://biscuitos.github.io/blog/Human-Knowledge-Common/#B1)

![](/assets/PDB/HK/TH001502.png)
![](/assets/PDB/HK/TH001607.png)
![](/assets/PDB/HK/TH001616.png)
![](/assets/PDB/HK/TH001617.png)
![](/assets/PDB/HK/TH001618.png)

案例源码通过一个应用程序进行展示，应用程序首先在 29 行调用 mmap() 函数，通过匿名私有映射的方式分配了 BISCUITOS_MAP_SIZE 的虚拟内存，通过宏定义可以知道虚拟内存大小为 8MiB，那么接下来在 44-47 行分别按 2MiB 的偏移对虚拟内存进行访问，可以看到每个 2MiB 的虚拟区域都被访问了一次。为了调试方便进程在 50 行处调用 sleep(-1) 保持不退出. 至此程序的功能完结，案例代码很精简，另外当系统启动之后需要设置 THP 的策略为 always, 那么接下来通过下面的命令在 BiscuitOS 上进行实践:

{% highlight bash %}
# 修改系统物理内存大于 512MiB
vi BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/RunBiscuitOS.sh
- RAM_SIZE=512
+ RAM_SIZE=1024

# 进入源码目录
cd BiscuitOS/output/linux-${KERNEL_VERSION}-${ARCHITECTURE}/package/BiscuitOS-THP-ShmemHugepage-anonymous-default/
# 编译源码
make
# 安装驱动
make install
# Rootfs 打包
make pack
# 运行 BiscuitOS
make run

# THP Enable always
echo always > /sys/kernel/mm/transparent_hugepage/enabled

# 后台方式运行程序
BiscuitOS-THP-AnonHugepage-default &

# 查看 ShmemHugepage 使用情况
cat /proc/meminfo | grep Huge
{% endhighlight %}

![](/assets/PDB/HK/TH001619.png)

可以看到当系统启动之后，向 "/sys/kernel/mm/transparent_hugepage/enabled" 写入 always 时，那么 THP 的策略就是直接分配. 接着后台运行应用程序 BiscuitOS-THP-AnonHugepage-default，此时查看 AnonHugepage 的使用情况，可以看出此时进程占用了 4 个 AnonHugepage 大页，总共 8MiB 物理内存，这与源码访问 8MiB 虚拟内存对应. 至此实践完毕符合预期.

![](/assets/PDB/BiscuitOS/kernel/IND000100.png)

